<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SCLOG Smart Course Learning Outcome Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Custom CSS -->
  <link href="custom.css" rel="stylesheet" />
</head>

<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-custom p-3">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="fw-bold">
        <i class="bi bi-stars me-2"></i> SCLOG Course Learning Outcome Generator
      </div>

      <div class="d-flex align-items-center">
        <label class="me-2 fw-semibold">Discipline:</label>
        <select id="profile" class="form-select form-select-sm">
          <option value="">Medical & Health Sciences</option>
          <option value="health">Medical & Health Sciences (explicit)</option>
          <option value="sc">Computer Science & IT</option>
          <option value="eng">Engineering & Technology</option>
          <option value="socs">Social Sciences</option>
          <option value="edu">Education</option>
          <option value="bus">Business & Management</option>
          <option value="arts">Arts & Humanities</option>
        </select>
      </div>
    </div>
  </nav>

  <main class="container my-4">

    <div class="card p-3 mb-4">
      <form id="cloForm" method="POST">
        <input type="hidden" id="profileHidden" name="profile" value="{{ profile }}" />

        <div class="row g-4">

          <!-- COURSE & MAPPING -->
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <span class="icon-badge"><i class="bi bi-journal-text"></i></span>
                Course & Mapping
              </div>
              <div class="card-body">
                <label class="form-label">Course Code / Name *</label>
                <input name="course" class="form-control" required />

                <label class="form-label mt-3">PLO *</label>
                <select id="plo" name="plo" class="form-select" required>
                  <option value="" disabled selected>Select PLO</option>
                  {% for p in plos %}
                  <option value="{{ p }}">{{ p }}</option>
                  {% endfor %}
                </select>

                <div class="row mt-3">
                  <div class="col-md-4">
                    <label class="form-label">SC Code</label>
                    <input id="sc_code" class="form-control" readonly />
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">SC Description</label>
                    <input id="sc_desc" class="form-control" readonly />
                  </div>
                </div>

                <div class="row mt-3">
                  <div class="col-md-6">
                    <label class="form-label">VBE</label>
                    <input id="vbe" class="form-control" readonly />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Domain</label>
                    <input id="domain" class="form-control" readonly />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- BLOOM & VERB -->
          <div class="col-lg-6">
            <div class="card">
              <div class="card-header">
                <span class="icon-badge"><i class="bi bi-layers"></i></span>
                Bloom & Verbs
              </div>
              <div class="card-body">
                <label class="form-label">Bloom Level *</label>
                <select id="bloom" name="bloom" class="form-select" required></select>

                <label class="form-label mt-3">Verb *</label>
                <select id="verb" name="verb" class="form-select" required></select>

                <label class="form-label mt-3">VBE Phrase Style</label>
                <select id="vbe_style" name="vbe_style" class="form-select">
                  <option value="guided">guided by …</option>
                  <option value="accordance">in accordance with …</option>
                  <option value="aligned">aligned with …</option>
                </select>
              </div>
            </div>
          </div>

          <!-- CONTENT & CONDITION -->
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <span class="icon-badge"><i class="bi bi-pencil"></i></span>
                CLO Builder
              </div>
              <div class="card-body">
                <label class="form-label">Content *</label>
                <input name="content" class="form-control" placeholder="e.g., ECG waveforms" required />

                <div class="row mt-3">
                  <div class="col-md-4">
                    <label class="form-label">Condition</label>
                    <input id="condition" class="form-control" readonly />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Criterion</label>
                    <input id="criterion" class="form-control" readonly />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Assessment %</label>
                    <input type="number" name="cw" min="0" max="100" class="form-control" />
                  </div>
                </div>

              </div>
            </div>
          </div>

          <!-- ASSESSMENT -->
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <span class="icon-badge"><i class="bi bi-clipboard-check"></i></span>
                Assessment
              </div>
              <div class="card-body">
                <label class="form-label">Assessment</label>
                <input id="assessment" class="form-control" readonly />

                <label class="form-label mt-3">Evidence</label>
                <input id="evidence" class="form-control" readonly />
              </div>
            </div>
          </div>

          <!-- BUTTONS -->
          <div class="col-12 d-flex justify-content-between mt-3">
            <div>
              <a href="/download" class="btn btn-outline-success me-2">
                <i class="bi bi-download"></i> Download CLO Table
              </a>
              <a href="/download_rubric" class="btn btn-outline-secondary">
                <i class="bi bi-file-earmark-spreadsheet"></i> Download Rubric
              </a>
            </div>
            <button type="submit" class="btn btn-primary">
              Generate CLO
            </button>
          </div>

        </div>
      </form>
    </div>

    <!-- CLO PREVIEW -->
    <div class="card mt-4" id="cloPreviewCard" style="display:none;">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>
          <span class="icon-badge"><i class="bi bi-lightbulb"></i></span> Generated CLO
        </div>
        <button id="copyCloBtn" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-clipboard"></i> Copy
        </button>
      </div>
      <div class="card-body">
        <p id="cloPreviewText"></p>
        <hr>
        <div class="fw-semibold">Other options:</div>
        <div id="altOptions"></div>
      </div>
    </div>

    <!-- RUBRIC -->
    <div class="card mt-4" id="rubricCard" style="display:none;">
      <div class="card-header">
        <span class="icon-badge"><i class="bi bi-list-check"></i></span>
        CLO Rubric
      </div>
      <div class="card-body">
        <table class="table table-bordered">
          <tr><th>Indicator</th><td id="r_indicator"></td></tr>
          <tr><th>Excellent</th><td id="r_excellent"></td></tr>
          <tr><th>Good</th><td id="r_good"></td></tr>
          <tr><th>Satisfactory</th><td id="r_satisfactory"></td></tr>
          <tr><th>Poor</th><td id="r_poor"></td></tr>
        </table>
      </div>
    </div>

  </main>

  <!-- FOOTER -->
  <footer>
    <strong>SCLOG Generator</strong><br>
    Developed by Assoc. Prof. Dr. Hazwani Ahmad Yusof @ Hanafi,<br>
    Advanced Medical and Dental Institute, Universiti Sains Malaysia (USM)
  </footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* --------------------------------------------------
   ELEMENTS
-------------------------------------------------- */
const profileSel = document.getElementById('profile');
const profileHidden = document.getElementById('profileHidden');
const ploSel = document.getElementById('plo');
const bloomSel = document.getElementById('bloom');
const verbSel = document.getElementById('verb');

const scCode = document.getElementById('sc_code');
const scDesc = document.getElementById('sc_desc');
const vbe    = document.getElementById('vbe');
const domain = document.getElementById('domain');

const condEl  = document.getElementById('condition');
const critEl  = document.getElementById('criterion');
const assessEl= document.getElementById('assessment');
const evidEl  = document.getElementById('evidence');

const form = document.getElementById('cloForm');

/* --------------------------------------------------
   DISCIPLINE-BASED CONTENT PLACEHOLDER
-------------------------------------------------- */
const contentInput = document.querySelector('input[name="content"]');
const contentPlaceholderMap = {
  "":    ["e.g., ECG waveforms","e.g., respiratory function indicators","e.g., exercise metabolism responses"],
  "health": ["e.g., ECG waveforms","e.g., patient functional assessment data","e.g., clinical exercise prescription parameters"],
  "sc":   ["e.g., algorithm complexity results","e.g., API response logs","e.g., software test cases"],
  "eng":  ["e.g., circuit load measurements","e.g., CAD model specifications","e.g., stress-strain datasets"],
  "socs": ["e.g., demographic survey datasets","e.g., community behavioural indicators","e.g., qualitative interview themes"],
  "edu":  ["e.g., lesson plan structure","e.g., student learning profiles","e.g., assessment rubric elements"],
  "bus":  ["e.g., financial ratio trends","e.g., market segmentation data","e.g., strategic planning frameworks"],
  "arts": ["e.g., colour theory elements","e.g., visual composition structures","e.g., creative conceptual briefs"]
};

function updateContentPlaceholder(){
  const selected = profileSel.value || "";
  const options = contentPlaceholderMap[selected] || ["Enter content here"];
  contentInput.placeholder = options[Math.floor(Math.random() * options.length)];
}
profileSel.addEventListener("change", updateContentPlaceholder);
updateContentPlaceholder();

/* --------------------------------------------------
   HELPERS & API HANDLING
-------------------------------------------------- */
function suffix(){
  const p = profileHidden.value || profileSel.value;
  return p ? `?profile=${encodeURIComponent(p)}` : "";
}

async function fetchJSON(url){
  const r = await fetch(url);
  return r.ok ? r.json() : null;
}

async function refreshBlooms(plo) {
  bloomSel.innerHTML = '<option disabled selected>Select Bloom</option>';
  verbSel.innerHTML = '<option disabled selected>Select Verb</option>';
  const data = await fetchJSON(`/api/get_blooms/${encodeURIComponent(plo)}${suffix()}`);
  if(data) data.forEach(b => {
    const opt = document.createElement('option');
    opt.value = opt.textContent = b;
    bloomSel.appendChild(opt);
  });
}
async function refreshVerbs(plo, bloom) {
  verbSel.innerHTML = '<option disabled selected>Select Verb</option>';
  const data = await fetchJSON(`/api/get_verbs/${plo}/${bloom}${suffix()}`);
  if(data) data.forEach(v => {
    const opt = document.createElement('option');
    opt.value = opt.textContent = v;
    verbSel.appendChild(opt);
  });
}
async function refreshMeta(plo,bloom) {
  const m = await fetchJSON(`/api/get_meta/${plo}/${bloom}${suffix()}`);
  if(!m) return;
  scCode.value = m.sc_code;
  scDesc.value = m.sc_desc;
  vbe.value    = m.vbe;
  domain.value = m.domain;
  condEl.value = m.condition;
  critEl.value = m.criterion;
  assessEl.value = m.assessment;
  evidEl.value   = m.evidence;
}

ploSel.addEventListener('change', async () => {
  await refreshBlooms(ploSel.value);
  bloomSel.value = "";
  verbSel.value = "";
  condEl.value = critEl.value = assessEl.value = evidEl.value = "";
  document.getElementById('cloPreviewCard').style.display = 'none';
});

bloomSel.addEventListener('change', async () => {
  await refreshVerbs(ploSel.value, bloomSel.value);
  await refreshMeta(ploSel.value, bloomSel.value);
});

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = await (await fetch("/generate" + suffix(), {
    method: "POST",
    body: new FormData(form)
  })).json();
  document.getElementById('cloPreviewCard').style.display = 'block';
  document.getElementById('cloPreviewText').innerText = data.clo;

  const alt = document.getElementById('altOptions');
  alt.innerHTML = "";
  Object.entries(data.clo_options).forEach(([name, txt]) => {
    const div = document.createElement("div");
    div.className = "option";
    div.innerText = `${name}: ${txt}`;
    div.onclick = () => {
      document.querySelectorAll(".option").forEach(n => n.classList.remove("active-option"));
      div.classList.add("active-option");
      document.getElementById('cloPreviewText').innerText = txt;
    };
    alt.appendChild(div);
  });

  document.getElementById('rubricCard').style.display = 'block';
  document.getElementById('r_indicator').innerText    = data.rubric.indicator;
  document.getElementById('r_excellent').innerText    = data.rubric.excellent;
  document.getElementById('r_good').innerText         = data.rubric.good;
  document.getElementById('r_satisfactory').innerText = data.rubric.satisfactory;
  document.getElementById('r_poor').innerText        = data.rubric.poor;

  assessEl.value = data.assessment;
  evidEl.value   = data.evidence;
});

document.getElementById('copyCloBtn').addEventListener('click', async () => {
  try { await navigator.clipboard.writeText(document.getElementById('cloPreviewText').innerText.trim()); }
  catch {}
});
</script>

</body>
</html>
