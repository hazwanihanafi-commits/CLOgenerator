<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SCLOG — Smart CLO Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root{
      --bg:#f7f9fc; --card:#fff; --text:#1f2937;
    }
    .dark {
      --bg:#0b1220; --card:#0f1724; --text:#e6eef8;
    }
    body { background:var(--bg); color:var(--text); }
    .card-panel { background:var(--card); border-radius:12px; padding:16px; box-shadow:0 6px 20px rgba(2,6,23,0.06); }
    .sidebar { height:100vh; position:sticky; top:0; padding:16px; }
    .variant-item { cursor:pointer; border-radius:8px; padding:8px; background:rgba(0,0,0,0.03); margin-bottom:8px; }
    .muted { color: #6b7280; font-size:0.9rem; }
    .small-muted { color: #9aa4b2; font-size:0.85rem; }
    .suggest-btn { margin-right:6px; margin-bottom:6px; }
    @media (max-width:991px) {
      .sidebar { height:auto; position:relative; }
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- SIDEBAR -->
      <aside class="col-lg-3 sidebar">
        <div class="card-panel">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h4 class="h5 mb-0">SCLOG</h4>
            <div>
              <button id="darkToggle" class="btn btn-sm btn-outline-secondary">Dark</button>
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label small-muted">Profile</label>
            <select id="profile" class="form-select form-select-sm">
              <option value="health">Medical & Health</option>
              <option value="sc" selected>Computer Science</option>
              <option value="eng">Engineering</option>
              <option value="socs">Social Sciences</option>
              <option value="edu">Education</option>
              <option value="bus">Business</option>
              <option value="arts">Arts & Humanities</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label small-muted">Field (for content suggestions)</label>
            <select id="fieldSelect" class="form-select form-select-sm">
              <option>Computer Science</option>
              <option>Medical & Health</option>
              <option>Engineering</option>
              <option>Social Sciences</option>
              <option>Education</option>
              <option>Business</option>
              <option>Arts & Humanities</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label small-muted">Level</label>
            <select id="level" class="form-select form-select-sm">
              <option>Degree</option>
              <option>Diploma</option>
              <option>Master</option>
              <option>PhD</option>
            </select>
          </div>

          <div class="d-grid gap-2">
            <button id="downloadBtn" class="btn btn-outline-success btn-sm">Download CLO Excel</button>
            <button id="downloadRubricBtn" class="btn btn-outline-secondary btn-sm">Download Rubric</button>
          </div>

          <hr />

          <div>
            <h6 class="mb-1">Quick content suggestions</h6>
            <div id="suggestionsArea" class="d-flex flex-wrap"></div>
          </div>

          <hr />

          <div>
            <small class="small-muted">Made for USM — Smart CLO generator</small>
          </div>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="col-lg-9 py-3">
        <div class="card-panel mb-3">
          <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
              <button class="nav-link active" id="nav-builder-tab" data-bs-toggle="tab" data-bs-target="#nav-builder" type="button">Builder</button>
              <button class="nav-link" id="nav-variants-tab" data-bs-toggle="tab" data-bs-target="#nav-variants" type="button">Variants</button>
              <button class="nav-link" id="nav-assess-tab" data-bs-toggle="tab" data-bs-target="#nav-assess" type="button">Assessment</button>
            </div>
          </nav>

          <div class="tab-content mt-3">
            <!-- BUILDER TAB -->
            <div class="tab-pane fade show active" id="nav-builder">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label small-muted">IEG</label>
                  <select id="ieg" class="form-select form-select-sm"></select>
                </div>
                <div class="col-md-6">
                  <label class="form-label small-muted">PEO</label>
                  <select id="peo" class="form-select form-select-sm"></select>
                </div>

                <div class="col-md-6">
                  <label class="form-label small-muted">PLO</label>
                  <select id="plo" class="form-select form-select-sm"></select>
                </div>

                <div class="col-md-6">
                  <label class="form-label small-muted">Bloom</label>
                  <select id="bloom" class="form-select form-select-sm"></select>
                </div>

                <div class="col-md-6">
                  <label class="form-label small-muted">Verb</label>
                  <select id="verb" class="form-select form-select-sm"></select>
                </div>

                <div class="col-md-6">
                  <label class="form-label small-muted">Content (topic / object)</label>
                  <input id="content" class="form-control form-control-sm" placeholder="e.g., interpret ECG waveforms" />
                </div>

                <div class="col-12">
                  <div class="d-flex gap-2">
                    <button id="generateBtn" class="btn btn-primary btn-sm">Generate CLO</button>
                    <button id="clearBtn" class="btn btn-outline-secondary btn-sm">Clear</button>
                    <div id="busy" style="display:none;" class="align-self-center">Generating…</div>
                  </div>
                </div>

                <div class="col-12" id="previewCard" style="display:none;">
                  <div class="border rounded p-3 bg-light">
                    <div class="d-flex justify-content-between">
                      <div>
                        <h6 class="mb-1">Generated CLO</h6>
                        <div id="cloPreview" class="fw-semibold"></div>
                      </div>
                      <div>
                        <button id="copyClo" class="btn btn-sm btn-outline-secondary">Copy</button>
                      </div>
                    </div>

                    <div class="mt-3 small-muted">PLO statement: <span id="ploStatement">—</span></div>
                    <div class="small-muted">PEO statement: <span id="peoStatement">—</span></div>
                    <div class="small-muted">PLO indicator: <span id="ploIndicator">—</span></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- VARIANTS TAB -->
            <div class="tab-pane fade" id="nav-variants">
              <div id="variantsPanelArea" class="row g-3"></div>
            </div>

            <!-- ASSESSMENT TAB -->
            <div class="tab-pane fade" id="nav-assess">
              <div id="assessArea"></div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- JS libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // Helper refs
  const iegSel = document.getElementById('ieg');
  const peoSel = document.getElementById('peo');
  const ploSel = document.getElementById('plo');
  const bloomSel = document.getElementById('bloom');
  const verbSel = document.getElementById('verb');
  const contentInput = document.getElementById('content');
  const profileSel = document.getElementById('profile');
  const fieldSel = document.getElementById('fieldSelect');
  const levelSel = document.getElementById('level');

  const suggestionsArea = document.getElementById('suggestionsArea');
  const suggestionsMap = {
    "Computer Science": ["debug algorithms","design software modules","analyze data structures","implement machine learning models","develop RESTful APIs"],
    "Medical & Health": ["interpret ECG waveforms","assess patient vital signs","perform clinical screenings","analyze medical imaging","evaluate rehabilitation progress"],
    "Engineering": ["apply thermodynamics principles","analyze structural loads","simulate mechanical systems","perform quality testing","design basic prototypes"],
    "Social Sciences": ["evaluate community case studies","analyze social policy impact","interpret behavioral data","conduct needs assessments","design surveys"],
    "Education": ["design learning activities","evaluate student performance","develop curriculum materials","apply instructional strategies","design assessment rubrics"],
    "Business": ["analyze market trends","evaluate financial reports","develop business strategies","conduct SWOT analysis","build simple financial models"],
    "Arts & Humanities": ["interpret visual artworks","analyze literary texts","evaluate cultural narratives","produce creative concepts","write reflective critiques"]
  };

  // Global store for last generated data
  let LAST = null;

  // Dark mode toggle
  const darkBtn = document.getElementById('darkToggle');
  darkBtn.addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
    darkBtn.innerText = document.documentElement.classList.contains('dark') ? 'Light' : 'Dark';
  });

  // Load mapping JSON and populate IEG / PEO / PLO
  async function loadMapping() {
    try {
      const map = await fetch('/api/mapping').then(r => r.json());
      window.MAP = map;

      // populate IEGs
      iegSel.innerHTML = '<option value="">Select IEG</option>';
      (map.IEGs || []).forEach(i => iegSel.add(new Option(i,i)));

      // pre-populate PLO master (fallback)
      ploSel.innerHTML = '<option value="">Select PLO</option>';
      (map.PLOs || []).forEach(p => ploSel.add(new Option(p,p)));

      renderSuggestions();
    } catch (e) {
      console.error('loadMapping error', e);
    }
  }

  function renderSuggestions() {
    suggestionsArea.innerHTML = '';
    const f = fieldSel.value || 'Computer Science';
    const list = suggestionsMap[f] || [];
    list.forEach(s => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-sm btn-outline-primary suggest-btn';
      btn.innerText = s;
      btn.onclick = () => contentInput.value = s;
      suggestionsArea.appendChild(btn);
    });
  }

  fieldSel.addEventListener('change', renderSuggestions);
  profileSel.addEventListener('change', () => {
    // update profile queries used later; we keep client-side selection
  });

  // IEG -> PEO (API then fallback)
  iegSel.addEventListener('change', async () => {
    const ieg = iegSel.value;
    peoSel.innerHTML = '<option>Loading…</option>';
    try {
      const list = await fetch(`/api/get_peos/${encodeURIComponent(ieg)}`).then(r => r.json());
      peoSel.innerHTML = '<option value="">Select PEO</option>';
      (list || []).forEach(p => peoSel.add(new Option(p,p)));
    } catch(e){
      peoSel.innerHTML = '<option value="">—</option>';
    }
  });

  // PEO -> PLO
  peoSel.addEventListener('change', async () => {
    const peo = peoSel.value;
    ploSel.innerHTML = '<option>Loading…</option>';
    try {
      const list = await fetch(`/api/get_plos/${encodeURIComponent(peo)}`).then(r => r.json());
      ploSel.innerHTML = '<option value="">Select PLO</option>';
      (list || []).forEach(p => ploSel.add(new Option(p,p)));
    } catch(e){
      ploSel.innerHTML = '<option value="">—</option>';
    }
  });

  // PLO -> Blooms
  ploSel.addEventListener('change', async () => {
    const plo = ploSel.value;
    bloomSel.innerHTML = '<option>Loading…</option>';
    try {
      const list = await fetch(`/api/get_blooms/${encodeURIComponent(plo)}?profile=${encodeURIComponent(profileSel.value)}`).then(r => r.json());
      bloomSel.innerHTML = '<option value="">Select Bloom</option>';
      (list || []).forEach(b => bloomSel.add(new Option(b,b)));
      // also try to auto-select PEO/IEG (client-side mapping)
      if (window.MAP && MAP.PEOtoPLO) {
        for (const [p, arr] of Object.entries(MAP.PEOtoPLO)) {
          if (Array.isArray(arr) && arr.includes(plo)) {
            peoSel.value = p;
            // attempt to set ieg
            for (const [i, peos] of Object.entries(MAP.IEGtoPEO)) {
              if (peos.includes(p)) { iegSel.value = i; break; }
            }
            break;
          }
        }
      }
      // load plo statement & indicator
      const lvl = levelSel.value;
      try {
        const stmt = await fetch(`/api/get_statement/${encodeURIComponent(lvl)}/PLO/${encodeURIComponent(plo)}`).then(r => r.json());
        document.getElementById('ploStatement').innerText = stmt || '—';
      } catch(e){
        document.getElementById('ploStatement').innerText = '—';
      }
    } catch(e){
      bloomSel.innerHTML = '<option value="">—</option>';
      console.error('blooms error', e);
    }
  });

  // Bloom -> verbs + meta
  bloomSel.addEventListener('change', async () => {
    const bloom = bloomSel.value;
    const plo = ploSel.value;
    verbSel.innerHTML = '<option>Loading…</option>';
    try {
      const verbs = await fetch(`/api/get_verbs/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}?profile=${encodeURIComponent(profileSel.value)}`).then(r => r.json());
      verbSel.innerHTML = '<option value="">Select Verb</option>';
      (verbs || []).forEach(v => verbSel.add(new Option(v,v)));
    } catch(e) {
      verbSel.innerHTML = '<option value="">—</option>';
    }

    // meta
    try {
      const m = await fetch(`/api/get_meta/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}?profile=${encodeURIComponent(profileSel.value)}`).then(r => r.json());
      document.getElementById('ploIndicator').innerText = (window.MAP && MAP.PLOIndicators && MAP.PLOIndicators[plo]) ? MAP.PLOIndicators[plo] : '—';
      document.getElementById('peoStatement').innerText = '—';
      document.getElementById('sc_desc')?.remove?.(); // just avoid errors if not present
      // condition / criterion not shown directly here but used by generator
    } catch(e){
      console.error('meta error', e);
    }
  });

  // Generate CLO
  document.getElementById('generateBtn').addEventListener('click', async () => {
    const plo = ploSel.value;
    const bloom = bloomSel.value;
    const verb = verbSel.value;
    const content = contentInput.value.trim();
    const profile = profileSel.value;
    const field = fieldSel.value;
    const level = levelSel.value;

    if (!plo || !bloom || !verb) { alert('Please choose PLO, Bloom and Verb'); return; }

    document.getElementById('busy').style.display = 'inline-block';
    try {
      const fd = new FormData();
      fd.append('profile', profile);
      fd.append('plo', plo);
      fd.append('bloom', bloom);
      fd.append('verb', verb);
      fd.append('content', content);
      fd.append('field', field);
      fd.append('level', level);

      const res = await fetch('/generate', { method: 'POST', body: fd });
      if (!res.ok) {
        const err = await res.text();
        throw new Error(err || 'Generate failed');
      }
      const data = await res.json();
      LAST = data;

      // preview panel
      document.getElementById('cloPreview').innerText = data.clo || '';
      document.getElementById('peoStatement').innerText = data.peo_statement || '—';
      document.getElementById('ploStatement').innerText = data.plo_statement || '—';
      document.getElementById('ploIndicator').innerText = (MAP.PLOIndicators && MAP.PLOIndicators[data.plo]) ? MAP.PLOIndicators[data.plo] : '—';
      document.getElementById('previewCard').style.display = 'block';

      // variants tab content
      const variantsArea = document.getElementById('variantsPanelArea');
      variantsArea.innerHTML = '';
      for (const [label, text] of Object.entries(data.clo_options || {})) {
        const div = document.createElement('div');
        div.className = 'col-md-6';
        div.innerHTML = `<div class="variant-item"><strong>${label}</strong><div class="mt-1">${text}</div></div>`;
        div.onclick = () => { contentInput.value = text; document.getElementById('cloPreview').innerText = text; };
        variantsArea.appendChild(div);
      }

      // assessment tab
      const assessArea = document.getElementById('assessArea');
      assessArea.innerHTML = '';
      const asses = data.assessments || [];
      if (asses.length) {
        asses.forEach(a => {
          const card = document.createElement('div');
          card.className = 'card mb-2';
          card.innerHTML = `<div class="card-body p-2"><strong>${a.assessment}</strong><div class="muted small">${(a.evidence||[]).join(', ')}</div></div>`;
          assessArea.appendChild(card);
        });
      } else {
        assessArea.innerHTML = '<div class="small-muted">No assessment suggestions available.</div>';
      }

    } catch (err) {
      alert('Error: ' + err.message);
      console.error(err);
    } finally {
      document.getElementById('busy').style.display = 'none';
    }
  });

  // Copy CLO
  document.getElementById('copyClo').addEventListener('click', async () => {
    const txt = document.getElementById('cloPreview').innerText;
    if (!txt) return;
    try {
      await navigator.clipboard.writeText(txt);
      document.getElementById('copyClo').innerText = 'Copied';
      setTimeout(()=> document.getElementById('copyClo').innerText = 'Copy', 1200);
    } catch(e) { alert('Copy failed'); }
  });

  // downloads
  document.getElementById('downloadBtn').addEventListener('click', () => {
    window.location = '/download';
  });
  document.getElementById('downloadRubricBtn').addEventListener('click', () => {
    window.location = '/download_rubric';
  });

  // clear form
  document.getElementById('clearBtn').addEventListener('click', () => {
    ploSel.value = '';
    bloomSel.value = '';
    verbSel.innerHTML = '<option value="">Select Verb</option>';
    contentInput.value = '';
    document.getElementById('previewCard').style.display = 'none';
  });

  // init
  (function init() {
    loadMapping();
    renderSuggestions();
  })();
  </script>
</body>
</html>
