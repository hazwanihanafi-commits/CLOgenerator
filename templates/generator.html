<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SCLOG Course Learning Outcome Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: #f4f4fb;
      font-family: 'Inter', sans-serif;
    }
    .navbar-custom {
      background: #5a2ca0;
    }
    .navbar-custom .navbar-brand {
      color: white;
      font-weight: 700;
    }
    .navbar-custom select {
      background: white;
      color: black;
    }
    .card {
      border-radius: 1rem;
      border: none;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }
    .card-header {
      background: white;
      border: none;
      font-weight: 600;
      color: #4a336c;
      font-size: 1.1rem;
    }
    footer {
      margin-top: 40px;
      padding: 15px;
      text-align: center;
      font-size: .9rem;
      color: #666;
    }
  </style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-custom navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand" href="#">SCLOG CLO Generator</a>

    <!-- Discipline dropdown -->
    <div>
      <select id="profile" class="form-select form-select-sm">
        <option value="">Medical & Health Sciences</option>
        <option value="sc">Computer Science & IT</option>
        <option value="eng">Engineering & Technology</option>
        <option value="socs">Social Sciences</option>
        <option value="edu">Education</option>
        <option value="bus">Business & Management</option>
        <option value="arts">Arts & Humanities</option>
      </select>
    </div>
  </div>
</nav>

<!-- MAIN -->
<div class="container my-4">

  <form id="cloForm" method="POST">

    <div class="row g-4">

      <!-- LEFT: COURSE + PLO MAPPING -->
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">Course & PLO Mapping</div>
          <div class="card-body">

            <label class="form-label">Course Code / Name</label>
            <input name="course" class="form-control" required>

            <label class="form-label mt-3">PLO *</label>
            <select name="plo" id="plo" class="form-select" required>
              <option disabled selected>Select PLO</option>
              {% for p in plos %}
                <option value="{{ p }}">{{ p }}</option>
              {% endfor %}
            </select>

            <div class="row mt-3">
              <div class="col-md-4">
                <label class="form-label">SC Code</label>
                <input id="sc_code" class="form-control" readonly>
              </div>
              <div class="col-md-8">
                <label class="form-label">SC Description</label>
                <input id="sc_desc" class="form-control" readonly>
              </div>
            </div>

            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label">VBE</label>
                <input id="vbe" class="form-control" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Domain</label>
                <input id="domain" class="form-control" readonly>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- RIGHT: BLOOM + VERB -->
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header">Bloom & Verb</div>
          <div class="card-body">

            <label class="form-label">Bloom Level *</label>
            <select name="bloom" id="bloom" class="form-select" required></select>

            <label class="form-label mt-3">Verb *</label>
            <select name="verb" id="verb" class="form-select" required></select>

          </div>
        </div>
      </div>

      <!-- CLO BUILDER -->
      <div class="col-12">
        <div class="card">
          <div class="card-header">CLO Builder</div>
          <div class="card-body">

            <label class="form-label">Content / Object *</label>
            <input name="content" class="form-control" placeholder="e.g., exercise metabolism; ECG interpretation; biomechanics of gait" required>

            <div class="row mt-3">
              <div class="col-md-4">
                <label class="form-label">Condition (Auto)</label>
                <input id="condition" class="form-control" readonly>
              </div>
              <div class="col-md-4">
                <label class="form-label">Criterion (Auto)</label>
                <input id="criterion" class="form-control" readonly>
              </div>
              <div class="col-md-4">
                <label class="form-label">Assessment %</label>
                <input type="number" name="cw" min="0" max="100" class="form-control">
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- ASSESSMENT -->
      <div class="col-12">
        <div class="card">
          <div class="card-header">Assessment & Evidence</div>
          <div class="card-body">

            <label class="form-label">Assessment Suggestion</label>
            <input id="assessment" name="assessment" class="form-control" readonly>

            <label class="form-label mt-3">Evidence of Assessment</label>
            <input id="evidence" name="evidence" class="form-control" readonly>

          </div>
        </div>
      </div>

      <!-- ACTION BUTTONS -->
      <div class="col-12">
        <div class="d-flex justify-content-between mt-3">
          <a href="{{ url_for('reset_table') }}" class="btn btn-outline-danger"><i class="bi bi-trash"></i> Reset</a>
          <a href="{{ url_for('download') }}" class="btn btn-outline-secondary"><i class="bi bi-download"></i> Download</a>
          <button class="btn btn-primary"><i class="bi bi-rocket-takeoff"></i> Generate CLO</button>
        </div>
      </div>

    </div>
  </form>

  <!-- PREVIEW -->
  <div class="card mt-4" id="cloPreviewCard" style="display:none;">
    <div class="card-header">Generated CLO</div>
    <div class="card-body">
      <p id="cloPreviewText" class="fw-bold text-primary"></p>
    </div>
  </div>

</div>

<!-- FOOTER -->
<footer>
  Developed by Assoc Prof Dr Hazwani Ahmad Yusof @ Hanafi (AMDI, USM)
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ============================
   PROFILE HANDLING
============================ */
const profileSel = document.getElementById("profile");
profileSel.value = "{{ profile }}";

profileSel.addEventListener("change", () => {
  const val = profileSel.value;
  const url = new URL(window.location.href);
  if (val) url.searchParams.set("profile", val);
  else url.searchParams.delete("profile");
  window.location.href = url.toString();
});

function profileSuffix() {
  const p = profileSel.value;
  return p ? `?profile=${p}` : "";
}

/* ============================
   UTIL: FETCH JSON
============================ */
async function fetchJSON(url) {
  const r = await fetch(url);
  if (!r.ok) return null;
  return await r.json();
}

/* ============================
   DOM ELEMENTS
============================ */
const ploSel = document.getElementById("plo");
const bloomSel = document.getElementById("bloom");
const verbSel  = document.getElementById("verb");

const scCode   = document.getElementById("sc_code");
const scDesc   = document.getElementById("sc_desc");
const vbe      = document.getElementById("vbe");
const domain   = document.getElementById("domain");

const condition = document.getElementById("condition");
const criterion = document.getElementById("criterion");
const assess    = document.getElementById("assessment");
const evidence  = document.getElementById("evidence");

/* ============================
   PLO → DETAILS
============================ */
async function refreshPLO(p) {
  const info = await fetchJSON(`/api/debug_plo/${p}${profileSuffix()}`);
  if (info && info.exists) {
    scCode.value = info.details.SC_Code || "";
    scDesc.value = info.details.SC_Desc || "";
    vbe.value    = info.details.VBE || "";
    domain.value = info.details.Domain || "";
  }
}

/* ============================
   PLO → BLOOMS
============================ */
async function refreshBlooms(p) {
  bloomSel.innerHTML = `<option disabled selected>Select Bloom</option>`;
  verbSel.innerHTML  = `<option disabled selected>Select Verb</option>`;
  const blooms = await fetchJSON(`/api/get_blooms/${p}${profileSuffix()}`) || [];
  blooms.forEach(b => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = b;
    bloomSel.appendChild(opt);
  });
}

/* ============================
   BLOOM → VERBS + META
============================ */
async function refreshVerbs(p, b) {
  verbSel.innerHTML = `<option disabled selected>Select Verb</option>`;
  const verbs = await fetchJSON(`/api/get_verbs/${p}/${b}${profileSuffix()}`) || [];
  verbs.forEach(v => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = v;
    verbSel.appendChild(opt);
  });
}

async function refreshMeta(p, b) {
  const meta = await fetchJSON(`/api/get_meta/${p}/${b}${profileSuffix()}`);
  if (!meta) return;
  condition.value = meta.condition || "";
  criterion.value = meta.criterion || "";
  assess.value    = meta.assessment || "";
  evidence.value  = meta.evidence || "";
}

/* ============================
   EVENT BINDINGS
============================ */
ploSel.addEventListener("change", async () => {
  const p = ploSel.value;
  await refreshPLO(p);
  await refreshBlooms(p);
  condition.value = criterion.value = assess.value = evidence.value = "";
});

bloomSel.addEventListener("change", async () => {
  const p = ploSel.value;
  const b = bloomSel.value;
  if (!p || !b) return;
  await refreshVerbs(p, b);
  await refreshMeta(p, b);
});

/* ============================
   GENERATE CLO (AJAX)
============================ */
document.getElementById("cloForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const res = await fetch(`/generate${profileSuffix()}`, {
    method: "POST",
    body: new FormData(this)
  });
  const data = await res.json();

  document.getElementById("cloPreviewCard").style.display = "block";
  document.getElementById("cloPreviewText").innerText = data.clo;

  assess.value = data.assessment;
  evidence.value = data.evidence;
});

</script>

</body>
</html>
