<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SCLOG — Smart Course Learning Outcome Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap + icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    /* ==========================
       FUTURISTIC GLOBAL THEME
       ========================== */
    :root {
      --bg-light: #eef2f9;
      --bg-dark: #0c111d;
      --card-light: rgba(255,255,255,0.92);
      --card-dark: rgba(12,18,30,0.85);
      --accent: #4ea2ff;
      --accent-glow: rgba(78,162,255,0.28);
      --muted-light: #6b7280;
      --muted-dark: #aeb9d9;
      --radius: 14px;
    }

    /* base */
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background .25s ease, color .25s ease;
    }

    body[data-theme="light"] {
      background: linear-gradient(135deg, var(--bg-light), #f7faff);
      color: #10203a;
    }
    body[data-theme="dark"] {
      background: radial-gradient(circle at top, #162032, #0c111d);
      color: #e6f0ff;
    }

    * { box-sizing: border-box; transition: all .22s ease; }

    /* APP SHELL */
    .app-shell {
      display: flex;
      min-height: 100vh;
      gap: 26px;
      padding: 20px;
      max-width: 1500px;
      margin: 10px auto;
    }

    /* SIDEBAR */
    .sidebar {
      width: 320px;
      border-radius: var(--radius);
      padding: 18px;
      background: rgba(255,255,255,0.62);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.3);
      flex-shrink: 0;
    }
    body[data-theme="dark"] .sidebar {
      background: rgba(20,28,45,0.52);
      border: 1px solid rgba(255,255,255,0.06);
    }

    /* MAIN */
    .app-main { flex:1; }

    /* CARDS */
    .card-box {
      background: var(--card-light);
      border-radius: 14px;
      padding: 18px;
      border: 1px solid rgba(0,0,0,0.05);
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    }
    body[data-theme="dark"] .card-box {
      background: var(--card-dark);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 14px 30px rgba(0,0,0,0.35);
    }
    .card-box:hover { transform: translateY(-2px); box-shadow: 0 18px 40px rgba(78,162,255,0.12); }

    /* BRAND & TITLES */
    .brand {
      font-weight: 900;
      letter-spacing: -0.4px;
      font-size: 1.18rem;
      background: linear-gradient(90deg, #4ea2ff, #82d0ff);
      -webkit-background-clip: text;
      color: transparent !important;
      display:flex;
      gap:10px;
      align-items:center;
    }
    h4 { font-weight: 800; font-size: 1.55rem; margin:0; }
    h6 { font-weight:700; font-size: 1rem; margin:0; }

    .small-muted { color: rgba(16,32,56,0.55); font-size:.92rem; }
    body[data-theme="dark"] .small-muted { color: rgba(200,215,255,0.6); }

    /* FORM STYLING */
    .form-select, .form-control {
      border-radius: 12px !important;
      border: 1px solid rgba(0,0,0,0.08) !important;
      padding: 10px 12px !important;
      font-size: .95rem;
      background: rgba(255,255,255,0.70);
      backdrop-filter: blur(6px);
    }
    body[data-theme="dark"] .form-select, body[data-theme="dark"] .form-control {
      background: rgba(22,30,46,0.55);
      border: 1px solid rgba(255,255,255,0.06) !important;
    }
    .form-control:focus, .form-select:focus {
      box-shadow: 0 0 0 4px var(--accent-glow) !important;
      border-color: var(--accent) !important;
      outline: none !important;
    }

    /* BUTTONS */
    .btn { border-radius: 12px; font-weight: 700; padding: 8px 14px; }
    .btn-primary { background: linear-gradient(90deg,#4ea2ff,#1766d8); border: none; color: #fff; }
    .btn-outline-secondary { border-radius:12px; }

    /* TABS */
    .nav-tabs { border-bottom: none; }
    .nav-tabs .nav-link { border: 0; padding: 8px 12px; border-radius: 10px; margin-right:6px; }
    .nav-tabs .nav-link.active { background: linear-gradient(90deg,#e9f3ff,#f3fbff); color: #0b3b6a; }
    body[data-theme="dark"] .nav-tabs .nav-link.active { background: rgba(30,54,86,0.28); color: #dff0ff; }

    /* VARIANT ITEM */
    .variant-item { padding:10px; border-radius:10px; border:1px solid rgba(16,24,40,0.06); margin-bottom:8px; cursor:pointer; background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); }
    .loader { display:inline-block; width:16px; height:16px; border:2px solid rgba(0,0,0,0.08); border-top-color:var(--accent); border-radius:50%; animation:spin 0.9s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg);} }

    /* small UI bits */
    .field-chip { display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(78,162,255,0.08); color:var(--accent); margin-right:6px; font-size:.85rem; }
    .muted-pill { background: rgba(16,24,40,0.03); padding:6px 8px; border-radius:6px; font-size:.85rem; color:var(--muted-light); }

    /* footer */
    footer { width:100%; background: linear-gradient(90deg,#0b1220,#0d1728); color:#e3eefc; text-align:center; padding:14px 8px; margin-top:30px; border-radius:10px; font-size:.9rem; }

    /* -----------------------
       RESPONSIVE (MOBILE)
       ----------------------- */
    @media (max-width: 991px) {
      .app-shell { flex-direction: column; padding: 12px; gap: 14px; }
      /* ensure sidebar sits first on mobile */
      .sidebar { width:100%; order: 1; padding: 14px; }
      .app-main { order: 2; }
    }

    /* COMPACT MOBILE (<= 575px) */
    @media (max-width: 575px) {

      .card-box { padding: 12px !important; border-radius: 12px; box-shadow: 0 6px 14px rgba(0,0,0,0.06); }
      h4 { font-size: 1.18rem; }
      h6 { font-size: 0.95rem; }
      .form-label { font-size: 0.78rem; margin-bottom: 4px; }
      .form-select, .form-control { font-size: 0.86rem !important; padding: 8px 10px !important; }
      .btn { font-size: 0.82rem; padding: 7px 10px; border-radius:10px; }
      .nav-tabs { overflow-x:auto; white-space:nowrap; padding-bottom:4px; -webkit-overflow-scrolling: touch; }
      .nav-link { font-size: .88rem; display:inline-block; }
      .sidebar { padding: 12px; border-radius: 12px; }
      .brand { font-size: 1rem; }
    }

    /* Collapsible sidebar helper (for small screens) */
    body.sidebar-hidden .sidebar { display: none !important; }
    body.sidebar-hidden .app-main { order: 1; }

    /* utility */
    .text-muted-weak { color: rgba(16,32,56,0.45); font-size: .92rem; }
    body[data-theme="dark"] .text-muted-weak { color: rgba(200,215,255,0.55); }

    /* glow helper */
    .glow { border: 1px solid rgba(78,162,255,0.36); box-shadow: 0 6px 26px rgba(78,162,255,0.12); }

  </style>
</head>
<body data-theme="light">
  <div class="app-shell container-fluid">

    <!-- SIDEBAR (PROFILE) -->
    <aside class="sidebar">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div>
          <div class="brand mb-1"><i class="bi bi-stars" style="font-size:1.2rem;"></i> SCLOG</div>
          <div class="text-muted-weak">Smart CLO Generator — upgraded UI</div>
        </div>
        <!-- mobile collapse button -->
        <div class="d-md-none">
          <button id="toggleSidebar" class="btn btn-sm btn-outline-secondary" title="Hide profile"><i class="bi bi-chevron-up"></i></button>
        </div>
      </div>

      <div class="card-box mb-3 glow">
        <label class="form-label small-muted">Profile</label>
        <select id="profile" class="form-select mb-2">
          <option value="health">Medical & Health</option>
          <option value="sc" selected>Computer Science & IT</option>
          <option value="eng">Engineering & Technology</option>
          <option value="socs">Social Sciences</option>
          <option value="edu">Education</option>
          <option value="bus">Business & Management</option>
          <option value="arts">Arts & Humanities</option>
        </select>

        <label class="form-label small-muted">Level</label>
        <select id="level" class="form-select mb-2">
          <option>Diploma</option>
          <option>Degree</option>
          <option>Master</option>
          <option>PhD</option>
        </select>

        <hr>

        <label class="form-label small-muted">Field (content suggestions)</label>
        <select id="field" class="form-select mb-2">
          <option value="">— Select Field —</option>
          <option>Computer Science</option>
          <option>Medical & Health</option>
          <option>Engineering</option>
          <option>Social Sciences</option>
          <option>Education</option>
          <option>Business</option>
          <option>Arts & Humanities</option>
        </select>

        <div class="d-flex gap-2 mt-2">
          <button id="darkToggle" class="btn btn-outline-secondary btn-sm w-100"><i class="bi bi-moon"></i> Dark</button>
        </div>

        <hr>

        <div class="small-muted">Quick actions</div>
        <div class="d-grid gap-2 mt-2">
          <button id="downloadBtn" class="btn btn-success btn-sm"><i class="bi bi-download me-1"></i> Download CLO</button>
          <button id="downloadRubricBtn" class="btn btn-outline-secondary btn-sm"><i class="bi bi-file-earmark-text me-1"></i> Download Rubric</button>
        </div>
      </div>

      <div class="card-box">
        <div class="small-muted mb-2">IEG → PEO → PLO mapping</div>
        <label class="form-label small-muted">IEG</label>
        <select id="ieg" class="form-select mb-2"><option value="">Select IEG</option></select>

        <label class="form-label small-muted">PEO</label>
        <select id="peo" class="form-select mb-2"><option value="">Select PEO</option></select>

        <label class="form-label small-muted">PLO</label>
        <select id="plo" class="form-select mb-2"><option value="">Select PLO</option></select>

        <div class="mt-2 small-muted">Statements</div>
        <div class="mt-2">
          <div><strong>PEO:</strong> <span id="peo_statement" class="small-muted">—</span></div>
          <div><strong>PLO:</strong> <span id="plo_statement" class="small-muted">—</span></div>
          <div><strong>Indicator:</strong> <span id="plo_indicator" class="small-muted">—</span></div>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="app-main">
      <!-- Page header + title -->
      <div class="card-box mb-3 d-flex justify-content-between align-items-center">
        <div>
          <h4 class="mb-1">Smart CLO Builder</h4>
          <div class="small-muted">Create measurable course learning outcomes quickly</div>
        </div>

        <div class="d-flex align-items-center gap-3">
          <!-- show sidebar button for phones -->
          <button id="showSidebarBtn" class="btn btn-outline-secondary d-md-none"><i class="bi bi-person-lines-fill"></i></button>
          <div class="small-muted text-end d-none d-md-block">Made for 2025 • Responsive • Dark mode</div>
        </div>
      </div>

      <!-- Builder card -->
      <div class="card-box mb-3">
        <ul class="nav nav-tabs" id="tabNav" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="builder-tab" data-bs-toggle="tab" data-bs-target="#builder" type="button">Builder</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="variants-tab" data-bs-toggle="tab" data-bs-target="#variants" type="button">Variants</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="assessment-tab" data-bs-toggle="tab" data-bs-target="#assessment" type="button">Assessment</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">History</button>
          </li>
        </ul>

        <div class="tab-content mt-3">
          <!-- BUILDER -->
          <div class="tab-pane fade show active" id="builder">
            <div class="row g-3">
              <div class="col-lg-8">
                <div class="mb-2">
                  <label class="form-label small-muted">Bloom</label>
                  <select id="bloom" class="form-select"><option value="">Select Bloom</option></select>
                </div>
                <div class="mb-2">
                  <label class="form-label small-muted">Verb</label>
                  <select id="verb" class="form-select"><option value="">Select Verb</option></select>
                </div>
                <div class="mb-2">
                  <label class="form-label small-muted">Content (topic / object)</label>
                  <input id="content" class="form-control" placeholder="e.g., interpret ECG waveforms">
                </div>

                <div class="mt-2 d-flex gap-2">
                  <button id="generateBtn" class="btn btn-primary"><i class="bi bi-magic me-1"></i> Generate CLO</button>
                  <button id="copyBtn" class="btn btn-outline-secondary"><i class="bi bi-clipboard"></i> Copy</button>
                  <div id="busy" style="display:none;" class="align-self-center text-muted-weak"><span class="loader"></span> Generating...</div>
                </div>

                <div id="cloCard" class="mt-3 card-box" style="display:none;">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="mb-1">Generated CLO</h6>
                      <div id="clo_text" class="fw-semibold" style="line-height:1.35;"></div>
                    </div>
                    <div class="text-end small-muted">
                      <div id="meta_small">—</div>
                    </div>
                  </div>

                  <div class="mt-3">
                    <button id="toggleVariants" class="btn btn-sm btn-outline-primary">Show variants</button>
                    <div id="variantsPanel" style="display:none; margin-top:10px;"></div>
                  </div>
                </div>
              </div>

              <div class="col-lg-4">
                <div class="card-box">
                  <div class="small-muted mb-2">Mapping metadata</div>
                  <div class="mb-2"><strong>SC Code</strong><div id="sc_code" class="small-muted">—</div></div>
                  <div class="mb-2"><strong>SC Description</strong><div id="sc_desc" class="small-muted">—</div></div>
                  <div class="mb-2"><strong>VBE</strong><div id="vbe" class="small-muted">—</div></div>
                  <div class="mb-2"><strong>Domain</strong><div id="domain" class="small-muted">—</div></div>
                  <div class="mb-2"><strong>Condition</strong><div id="condition" class="small-muted">—</div></div>
                  <div class="mb-2"><strong>Criterion</strong><div id="criterion" class="small-muted">—</div></div>
                </div>

                <div class="card-box mt-3">
                  <div class="small-muted mb-1">Quick content suggestions</div>
                  <div id="content_suggestions"></div>
                </div>

              </div>
            </div>
          </div>

          <!-- VARIANTS -->
          <div class="tab-pane fade" id="variants">
            <div id="variants_list" class="tab-pane-content"></div>
          </div>

          <!-- ASSESSMENT -->
          <div class="tab-pane fade" id="assessment">
            <div class="row">
              <div class="col-lg-6">
                <div class="card-box">
                  <h6>Assessment methods</h6>
                  <div id="assess_list" class="small-muted">—</div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="card-box">
                  <h6>Suggested evidence</h6>
                  <div id="evidence_list" class="small-muted">—</div>
                </div>
              </div>
            </div>
          </div>

          <!-- HISTORY -->
          <div class="tab-pane fade" id="history">
            <div class="card-box">
              <h6>Recent generation</h6>
              <div id="history_list" class="small-muted">No history in this demo (server-side saved CLO available for download).</div>
            </div>
          </div>

        </div>
      </div>

    </main>
  </div>

  <footer>
    © 2025 • Developed by <strong>Assoc Prof Dr Hazwani Ahmad Yusof @ Hanafi</strong>,
    Universiti Sains Malaysia (USM)
  </footer>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* -------------------------
       Element refs & helpers
    --------------------------*/
    const $ = id => document.getElementById(id);

    const profileSel = $('profile');
    const levelSel = $('level');
    const fieldSel = $('field');
    const iegSel = $('ieg');
    const peoSel = $('peo');
    const ploSel = $('plo');

    const bloomSel = $('bloom');
    const verbSel = $('verb');
    const contentInput = $('content');

    const scCodeEl = $('sc_code'), scDescEl = $('sc_desc'), vbeEl = $('vbe'),
          domainEl = $('domain'), conditionEl = $('condition'), criterionEl = $('criterion');

    const cloCard = $('cloCard');
    const cloText = $('clo_text');
    const variantsPanel = $('variantsPanel');
    const variantsList = $('variants_list');
    const assessList = $('assess_list');
    const evidenceList = $('evidence_list');
    const contentSuggestionsEl = $('content_suggestions');

    const busyEl = $('busy');
    const downloadBtn = $('downloadBtn');
    const downloadRubricBtn = $('downloadRubricBtn');
    const darkToggle = $('darkToggle');
    const toggleVariantsBtn = $('toggleVariants');
    const copyBtn = $('copyBtn');
    const generateBtn = $('generateBtn');

    const toggleSidebar = $('toggleSidebar');
    const showSidebarBtn = $('showSidebarBtn');

    let LAST_CLO = null;

    /* -------------------------
       Dark mode toggle
    --------------------------*/
    darkToggle.addEventListener('click', () => {
      const curr = document.body.getAttribute('data-theme') || 'light';
      const next = curr === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', next);
      darkToggle.innerHTML = next === 'dark' ? '<i class="bi bi-sun"></i> Light' : '<i class="bi bi-moon"></i> Dark';
    });

    /* -------------------------
       Sidebar show/hide (mobile)
    --------------------------*/
    function hideSidebar() { document.body.classList.add('sidebar-hidden'); }
    function showSidebar() { document.body.classList.remove('sidebar-hidden'); }
    if (toggleSidebar) toggleSidebar.addEventListener('click', hideSidebar);
    if (showSidebarBtn) showSidebarBtn.addEventListener('click', showSidebar);

    /* -------------------------
       Load mapping JSON (from your backend)
    --------------------------*/
    async function loadMapping(){
      try {
        const res = await fetch('/api/mapping');
        const map = await res.json();
        window.MAP = map || {};
        iegSel.innerHTML = '<option value="">Select IEG</option>';
        (map.IEGs||[]).forEach(i => iegSel.add(new Option(i,i)));
        ploSel.innerHTML = '<option value="">Select PLO</option>';
        (map.PLOs||[]).forEach(p => ploSel.add(new Option(p,p)));
      } catch(err){
        console.warn('mapping load', err);
      }
    }

    /* -------------------------
       IEG -> PEO cascading
    --------------------------*/
    iegSel.addEventListener('change', async () => {
      const ieg = iegSel.value;
      peoSel.innerHTML = '<option value="">Loading…</option>';
      ploSel.innerHTML = '<option value="">Select PLO</option>';
      if (!ieg) { peoSel.innerHTML = '<option value="">Select PEO</option>'; return; }

      try {
        const res = await fetch(`/api/get_peos/${encodeURIComponent(ieg)}`);
        const peos = await res.json();
        peoSel.innerHTML = '<option value="">Select PEO</option>';
        (peos||[]).forEach(p => peoSel.add(new Option(p,p)));
      } catch(e){ console.error(e); peoSel.innerHTML = '<option value="">Error</option>'; }
    });

    /* -------------------------
       PEO -> PLO cascading
    --------------------------*/
    peoSel.addEventListener('change', async () => {
      const peo = peoSel.value;
      ploSel.innerHTML = '<option value="">Loading…</option>';
      if (!peo) { ploSel.innerHTML = '<option value="">Select PLO</option>'; return; }
      try {
        const res = await fetch(`/api/get_plos/${encodeURIComponent(peo)}`);
        const plos = await res.json();
        ploSel.innerHTML = '<option value="">Select PLO</option>';
        (plos||[]).forEach(p => ploSel.add(new Option(p,p)));
        // load PEO statement
        const level = levelSel.value || 'Degree';
        try {
          const stmtRes = await fetch(`/api/get_statement/${encodeURIComponent(level)}/PEO/${encodeURIComponent(peo)}`);
          const stmt = await stmtRes.json();
          $('peo_statement').textContent = stmt || '—';
        } catch(e){ $('peo_statement').textContent = '—'; }
      } catch(e){ console.error(e); ploSel.innerHTML = '<option value="">Error</option>'; }
    });

    /* -------------------------
       PLO -> Bloom + statements
    --------------------------*/
    ploSel.addEventListener('change', async () => {
      const plo = ploSel.value;
      bloomSel.innerHTML = '<option>Loading…</option>';
      if (!plo) { bloomSel.innerHTML = '<option value="">Select Bloom</option>'; return; }
      // Blooms
      try {
        const res = await fetch(`/api/get_blooms/${encodeURIComponent(plo)}?profile=${encodeURIComponent(profileSel.value)}`);
        const blooms = await res.json();
        bloomSel.innerHTML = '<option value="">Select Bloom</option>';
        (blooms||[]).forEach(b => bloomSel.add(new Option(b,b)));
      } catch(e){ bloomSel.innerHTML = '<option value="">Error</option>'; }

      // PLO statement + indicator
      const lvl = levelSel.value || 'Degree';
      try {
        const stmtRes = await fetch(`/api/get_statement/${encodeURIComponent(lvl)}/PLO/${encodeURIComponent(plo)}`);
        const stmt = await stmtRes.json();
        $('plo_statement').textContent = stmt || '—';
      } catch(e){ $('plo_statement').textContent = '—'; }

      try {
        const map = window.MAP || {};
        $('plo_indicator').textContent = (map.PLOIndicators && map.PLOIndicators[plo]) || '—';
      } catch(e){ $('plo_indicator').textContent = '—'; }
    });

    /* -------------------------
       Bloom -> verbs + meta
    --------------------------*/
    bloomSel.addEventListener('change', async () => {
      const bloom = bloomSel.value;
      const plo = ploSel.value;
      if (!bloom || !plo) return;
      try {
        const vres = await fetch(`/api/get_verbs/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}?profile=${encodeURIComponent(profileSel.value)}`);
        const verbs = await vres.json();
        verbSel.innerHTML = '<option value="">Select Verb</option>';
        (verbs||[]).forEach(v => verbSel.add(new Option(v,v)));
      } catch(e){ console.error(e); verbSel.innerHTML = '<option value="">Error</option>'; }

      try {
        const mres = await fetch(`/api/get_meta/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}?profile=${encodeURIComponent(profileSel.value)}`);
        const meta = await mres.json();
        scCodeEl.textContent = meta.sc_code || '—';
        scDescEl.textContent = meta.sc_desc || '—';
        vbeEl.textContent = meta.vbe || '—';
        domainEl.textContent = meta.domain || '—';
        conditionEl.textContent = meta.condition || '—';
        criterionEl.textContent = meta.criterion || '—';
      } catch(e){ console.error(e); }
    });

    /* -------------------------
       Field -> content suggestions
    --------------------------*/
    fieldSel.addEventListener('change', async () => {
      const field = fieldSel.value;
      contentSuggestionsEl.innerHTML = '';
      if (!field) return;
      try {
        const res = await fetch(`/api/content/${encodeURIComponent(field)}`);
        const list = await res.json();
        contentSuggestionsEl.innerHTML = '';
        (list||[]).forEach(s => {
          const btn = document.createElement('button');
          btn.className = 'btn btn-sm btn-light me-1 mb-1';
          btn.textContent = s;
          btn.onclick = () => { contentInput.value = s; };
          contentSuggestionsEl.appendChild(btn);
        });
      } catch(e){ console.error(e); }
    });

    /* -------------------------
       Generate CLO
    --------------------------*/
    generateBtn.addEventListener('click', async () => {
      if (!ploSel.value || !bloomSel.value || !verbSel.value || !contentInput.value.trim()){
        alert('Please fill PLO, Bloom, Verb and Content.');
        return;
      }
      busyEl.style.display = 'inline-block';
      generateBtn.disabled = true;

      const fd = new FormData();
      fd.append('profile', profileSel.value);
      fd.append('level', levelSel.value);
      fd.append('plo', ploSel.value);
      fd.append('bloom', bloomSel.value);
      fd.append('verb', verbSel.value);
      fd.append('content', contentInput.value);

      try {
        const res = await fetch('/generate', { method:'POST', body: fd});
        if (!res.ok) {
          const err = await res.json().catch(()=>({error:'Server error'}));
          throw new Error(err.error || 'Failed to generate');
        }
        const data = await res.json();
        LAST_CLO = data;
        // show CLO
        cloText.innerText = data.clo || '';
        cloCard.style.display = 'block';
        // show variants
        variantsPanel.innerHTML = '';
        const opts = data.clo_options || {};
        for (const [label, text] of Object.entries(opts)) {
          const div = document.createElement('div');
          div.className = 'variant-item';
          div.innerHTML = `<strong>${label}</strong><div class="mt-1">${text}</div>`;
          div.onclick = () => { cloText.innerText = text; };
          variantsPanel.appendChild(div);
        }
        // assessment
        const assessments = data.assessments || [];
        assessList.innerHTML = assessments.length ? ('<ul>' + assessments.map(a => `<li>${a}</li>`).join('') + '</ul>') : '—';
        // evidence
        const evidence = data.evidence || {};
        evidenceList.innerHTML = Object.keys(evidence).length ? Object.entries(evidence).map(([k,v]) => `<div><strong>${k}</strong>: ${v.join('; ')}</div>`).join('') : '—';
        // fill metadata fields in sidebar
        $('peo_statement').textContent = data.peo_statement || '—';
        $('plo_statement').textContent = data.plo_statement || '—';
        $('plo_indicator').textContent = data.plo_indicator || '—';
      } catch(err){
        console.error(err);
        alert('Error: ' + (err.message || 'Failed to generate'));
      } finally {
        busyEl.style.display = 'none';
        generateBtn.disabled = false;
      }
    });

    /* -------------------------
       Toggle variants panel
    --------------------------*/
    toggleVariantsBtn.addEventListener('click', () => {
      const hidden = variantsPanel.style.display === 'none' || variantsPanel.style.display === '';
      variantsPanel.style.display = hidden ? 'block' : 'none';
      toggleVariantsBtn.innerText = hidden ? 'Hide variants' : 'Show variants';
    });

    /* -------------------------
       Copy generated CLO
    --------------------------*/
    copyBtn.addEventListener('click', async () => {
      if (!cloText.innerText) return;
      try {
        await navigator.clipboard.writeText(cloText.innerText);
        copyBtn.innerText = 'Copied';
        setTimeout(()=> copyBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copy', 1200);
      } catch(e){ alert('Copy failed'); }
    });

    /* -------------------------
       Download buttons
    --------------------------*/
    downloadBtn.addEventListener('click', () => { window.location = '/download'; });
    downloadRubricBtn.addEventListener('click', () => { window.location = '/download_rubric'; });

    /* -------------------------
       Init
    --------------------------*/
    (function init(){
      loadMapping();
      // ensure sidebar visible on larger screens
      if (window.innerWidth >= 992) showSidebar();
    })();
  </script>
</body>
</html>
