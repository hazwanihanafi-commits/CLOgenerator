<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8">
  <title>CLO Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: #f5f4fb;
      font-family: 'Inter', sans-serif;
    }
    .navbar-custom {
      background-color: #5a2ca0;
    }
    .navbar-custom .navbar-brand, 
    .navbar-custom .nav-link,
    .navbar-custom label {
      color: #fff;
    }
    .brand-title {
      font-weight: 700;
      letter-spacing: .5px;
    }

    .card {
      border: 0;
      border-radius: 1rem;
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    .card-header {
      background: #fff;
      border-bottom: 0;
      font-weight: 600;
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      gap: .6rem;
      color: #3b2f5b;
    }
    .icon-badge {
      width: 40px; height: 40px; border-radius: 10px;
      background: #ede6ff;
      color: #5a2ca0;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
    }

    .btn-primary {
      background: #5a2ca0 !important;
      border-color: #5a2ca0 !important;
    }
    .nav-pills .nav-link.active {
      background-color: #5a2ca0;
    }
    .nav-pills .nav-link {
      color: #3b2f5b;
    }

    .sticky-actions {
      position: sticky; bottom: 0;
      background: #fff;
      padding: 1rem;
      border-radius: 1rem;
      box-shadow: 0 -6px 18px rgba(0,0,0,.06);
      margin-top: 1rem;
    }

    .table-container {
      overflow-x: auto;
    }
  </style>
</head>

<body>

  <!-- Top Navbar -->
  <nav class="navbar navbar-custom navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand brand-title" href="#">
        <i class="bi bi-magic me-2"></i>CLO Generator
      </a>

      <!-- Discipline dropdown -->
      <div class="d-flex align-items-center">
        <form id="profileForm" class="d-flex align-items-center text-white">
          <label class="me-2">Discipline:</label>
         <select id="profile" class="form-select form-select-sm">
        <option value="">Medical & Health Sciences</option>
        <option value="sc">Computer Science & IT</option>
        <option value="eng">Engineering & Technology</option>
       <option value="socs">Social Sciences</option>
         <option value="edu">Education</option>
        <option value="bus">Business & Management</option>
        <option value="arts">Arts & Humanities</option>
        </select>
        </form>
      </div>

    </div>
  </nav>

  <main class="container my-4">

    <!-- Tabs -->
    <ul class="nav nav-pills mb-3" id="cloTabs">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tabGenerate">
          <i class="bi bi-pencil-square me-1"></i>Generate CLO
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabHistory">
          <i class="bi bi-table me-1"></i>History
        </button>
      </li>
    </ul>

    <div class="tab-content">

      <!-- GENERATE CLO TAB -->
      <div class="tab-pane fade show active" id="tabGenerate">

        <form method="POST" action="{{ url_for('generate') }}" id="cloForm">

          <div class="row g-3">

            <!-- COURSE + PLO -->
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <span class="icon-badge"><i class="bi bi-journal-text"></i></span>
                  Course & Mapping
                </div>
                <div class="card-body">

                  <label class="form-label">Course Code / Name *</label>
                  <input name="course" class="form-control" required>

                  <label class="form-label mt-3">PLO *</label>
                  <select name="plo" id="plo" class="form-select" required>
                    <option value="" disabled selected>Select PLO</option>
                    {% for p in plos %}
                      <option value="{{ p }}">{{ p }}</option>
                    {% endfor %}
                  </select>

                  <div class="row mt-3">
                    <div class="col-md-4">
                      <label class="form-label">SC Code</label>
                      <input id="sc_code" class="form-control" readonly>
                    </div>
                    <div class="col-md-8">
                      <label class="form-label">SC Description</label>
                      <input id="sc_desc" class="form-control" readonly>
                    </div>
                  </div>

                  <div class="row mt-3">
                    <div class="col-md-6">
                      <label class="form-label">VBE</label>
                      <input id="vbe" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Domain</label>
                      <input id="domain" class="form-control" readonly>
                    </div>
                  </div>

                </div>
              </div>
            </div>

            <!-- BLOOM + VERB -->
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <span class="icon-badge"><i class="bi bi-bar-chart-steps"></i></span>
                  Bloom & Verbs
                </div>
                <div class="card-body">

                  <label class="form-label">Bloom Level *</label>
                  <select id="bloom" name="bloom" class="form-select" required></select>

                  <label class="form-label mt-3">Verb *</label>
                  <select id="verb" name="verb" class="form-select" required></select>

                </div>
              </div>
            </div>

            <!-- CLO BUILDER -->
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <span class="icon-badge"><i class="bi bi-pencil"></i></span>
                  CLO Builder
                </div>
                <div class="card-body">

                  <label class="form-label">Content / Object *</label>
                  <input name="content" class="form-control" required>

                  <div class="row mt-3">
                    <div class="col-md-4">
                      <label class="form-label">Condition</label>
                      <input id="condition" class="form-control" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Criterion</label>
                      <input id="criterion" class="form-control" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Assessment %</label>
                      <input type="number" min="0" max="100" step="1" name="cw" class="form-control">
                    </div>
                  </div>

                </div>
              </div>
            </div>

            <!-- ASSESSMENT -->
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <span class="icon-badge"><i class="bi bi-clipboard-check"></i></span>
                  Assessment
                </div>
                <div class="card-body">

                  <label class="form-label">Assessment Suggestion</label>
                  <input name="assessment" id="assessment" class="form-control" readonly>

                  <label class="form-label mt-3">Evidence of Assessment</label>
                  <input name="evidence" id="evidence" class="form-control" readonly>

                </div>
              </div>
            </div>

            <!-- ACTIONS -->
            <div class="col-12">
              <div class="sticky-actions d-flex justify-content-between">
                <div class="text-muted">
                  <i class="bi bi-info-circle"></i> Complete required fields then click Generate.
                </div>
                <div class="d-flex gap-2">
                  <a href="{{ url_for('reset_table') }}" class="btn btn-outline-danger">
                    <i class="bi bi-trash"></i> Reset History
                  </a>
                  <a href="{{ url_for('download') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-download"></i> Download
                  </a>
                  <button class="btn btn-primary">
                    <i class="bi bi-rocket-takeoff"></i> Generate
                  </button>
                </div>
              </div>
            </div>

          </div>
        </form>

        <!-- CLO PREVIEW CARD -->
        <div class="card mt-4" id="cloPreviewCard" style="display:none;">
          <div class="card-header">
            <span class="icon-badge"><i class="bi bi-lightbulb"></i></span>
            Generated CLO
          </div>
          <div class="card-body">
            <p id="cloPreviewText" style="font-size: 1.1rem; color:#3b2f5b; font-weight: 500;"></p>
          </div>
        </div>

      </div>

      <!-- HISTORY TAB -->
      <div class="tab-pane fade" id="tabHistory">

        <div class="card mt-3">
          <div class="card-header">
            <span class="icon-badge"><i class="bi bi-clock-history"></i></span>
            CLO History
          </div>
          <div class="card-body">

            <div id="historyPlaceholder" class="text-muted text-center">
              <i class="bi bi-eye"></i> Click to load history.
              <div class="mt-2">
                <button id="loadHistoryBtn" class="btn btn-outline-primary btn-sm">
                  Show History
                </button>
              </div>
            </div>

            <div id="historyArea" class="table-container" style="display:none;">
              <div id="historyHTML"></div>
            </div>

            <template id="serverTable">
              {{ table_html|safe }}
            </template>

          </div>
        </div>

      </div>

    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- MAIN SCRIPT -->
  <script>

    /* ======================
       PROFILE SWITCH
    =======================*/
    const profileSel = document.getElementById("profile");
    profileSel.value = "{{ profile }}";

    profileSel.addEventListener("change", function () {
        const val = this.value;
        const url = new URL(window.location.href);
        if (val) url.searchParams.set("profile", val);
        else url.searchParams.delete("profile");
        window.location.href = url.toString();
    });

    function profileSuffix() {
        const p = profileSel.value;
        return p ? `?profile=${p}` : "";
    }

    /* ======================
       UTIL: FETCH JSON
    =======================*/
    async function fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) return null;
        return await res.json();
    }

    /* ======================
       DOM ELEMENTS
    =======================*/
    const ploSel = document.getElementById("plo");
    const bloomSel = document.getElementById("bloom");
    const verbSel = document.getElementById("verb");
    const scCode = document.getElementById("sc_code");
    const scDesc = document.getElementById("sc_desc");
    const vbe = document.getElementById("vbe");
    const domain = document.getElementById("domain");
    const condition = document.getElementById("condition");
    const criterion = document.getElementById("criterion");
    const assess = document.getElementById("assessment");
    const evid = document.getElementById("evidence");

    /* ======================
       PLO → DETAILS
    =======================*/
    async function refreshPLO(p) {
        const info = await fetchJSON(`/api/debug_plo/${p}${profileSuffix()}`);
        if (info && info.exists) {
            scCode.value = info.details.SC_Code || "";
            scDesc.value = info.details.SC_Desc || "";
            vbe.value = info.details.VBE || "";
            domain.value = info.details.Domain || "";
        }
    }

    /* ======================
       PLO → BLOOMS
    =======================*/
    async function refreshBlooms(p) {
        bloomSel.innerHTML = `<option disabled selected>Select Bloom</option>`;
        verbSel.innerHTML = `<option disabled selected>Select Verb</option>`;
        const blooms = await fetchJSON(`/api/get_blooms/${p}${profileSuffix()}`) || [];
        blooms.forEach(b => {
            const opt = document.createElement("option");
            opt.value = opt.textContent = b;
            bloomSel.appendChild(opt);
        });
    }

    /* ======================
       BLOOM → VERBS
    =======================*/
    async function refreshVerbs(p, b) {
        verbSel.innerHTML = `<option disabled selected>Select Verb</option>`;
        const verbs = await fetchJSON(`/api/get_verbs/${p}/${b}${profileSuffix()}`) || [];
        verbs.forEach(v => {
            const opt = document.createElement("option");
            opt.value = opt.textContent = v;
            verbSel.appendChild(opt);
        });
    }

    /* ======================
       EVENT BINDING
    =======================*/
    ploSel?.addEventListener("change", async () => {
        const p = ploSel.value;
        await refreshPLO(p);
        await refreshBlooms(p);
    });

    bloomSel?.addEventListener("change", async () => {
        const b = bloomSel.value;
        const p = ploSel.value;
        if (p && b) await refreshVerbs(p, b);
    });

    /* ======================
       SUBMIT → LIVE CLO PREVIEW
    =======================*/
    document.getElementById("cloForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        const res = await fetch("/generate" + profileSuffix(), {
            method: "POST",
            body: formData
        });

        const data = await res.json();

        // Show CLO preview
        document.getElementById("cloPreviewCard").style.display = "block";
        document.getElementById("cloPreviewText").innerText = data.clo;

        assess.value = data.assessment;
        evid.value = data.evidence;
    });

    /* ======================
       HISTORY → LOAD ON DEMAND
    =======================*/
    const loadBtn = document.getElementById("loadHistoryBtn");
    const historyArea = document.getElementById("historyArea");
    const historyPlaceholder = document.getElementById("historyPlaceholder");
    const historyHTML = document.getElementById("historyHTML");
    const serverTable = document.getElementById("serverTable");

    function loadHistory() {
        historyHTML.innerHTML = serverTable.innerHTML;
        historyPlaceholder.style.display = "none";
        historyArea.style.display = "block";
    }

    loadBtn.addEventListener("click", loadHistory);
    document.querySelector('[data-bs-target="#tabHistory"]').addEventListener("shown.bs.tab", loadHistory);

  </script>

</body>
</html>
