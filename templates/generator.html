<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8" />
  <title>SCLOG Course Learning Outcome Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: #f4f2fb;
      font-family: 'Inter', sans-serif;
    }
    .navbar-custom {
      background-color: #5a2ca0;
    }
    .navbar-custom .navbar-brand, 
    .navbar-custom .nav-link,
    .navbar-custom label {
      color: #fff !important;
    }

    .brand-title {
      font-weight: 700;
      font-size: 1.25rem;
    }

    #developerNote {
      color: #ddd;
      font-size: 0.8rem;
      margin-top: -8px;
    }

    .card {
      border: 0;
      border-radius: 1rem;
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    .card-header {
      background: #fff;
      border-bottom: 0;
      font-weight: 600;
      font-size: 1.05rem;
      display: flex;
      align-items: center;
      gap: .6rem;
      color: #3b2f5b;
    }
    .icon-badge {
      width: 40px; height: 40px; border-radius: 10px;
      background: #ede6ff;
      color: #5a2ca0;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
    }

    .btn-primary {
      background: #5a2ca0 !important;
      border-color: #5a2ca0 !important;
    }

    .sticky-actions {
      position: sticky;
      bottom: 0;
      background: #fff;
      padding: 1rem;
      border-radius: 1rem;
      box-shadow: 0 -6px 18px rgba(0,0,0,.06);
      margin-top: 1rem;
    }

  </style>

</head>

<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-custom navbar-expand-lg">
    <div class="container">

      <div>
        <a class="navbar-brand brand-title" href="#">
          <i class="bi bi-magic me-2"></i>SCLOG Course Learning Outcome Generator
        </a>
        <div id="developerNote">Developed by Assoc Prof Dr Hazwani Ahmad Yusof@Hanafi (AMDI, USM)</div>
      </div>

      <div class="d-flex align-items-center">
        <form id="profileForm" class="d-flex align-items-center text-white">
          <label class="me-2">Discipline:</label>
          <select id="profile" class="form-select form-select-sm">
            <option value="">Medical & Health Sciences</option>
            <option value="sc">Computer Science & IT</option>
            <option value="eng">Engineering & Technology</option>
            <option value="socs">Social Sciences</option>
            <option value="edu">Education</option>
            <option value="bus">Business & Management</option>
            <option value="arts">Arts & Humanities</option>
          </select>
        </form>
      </div>

    </div>
  </nav><button id="darkToggle" class="btn btn-sm btn-outline-light ms-3">
   <i class="bi bi-moon-stars"></i>
</button>

  <main class="container my-4">

    <!-- TABS -->
    <ul class="nav nav-pills mb-3">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tabGenerate">
          <i class="bi bi-pencil-square me-1"></i>Generate CLO
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabHistory">
          <i class="bi bi-table me-1"></i>History
        </button>
      </li>
    </ul>

    <div class="tab-content">

      <!-- =================== GENERATE TAB =================== -->
      <div class="tab-pane fade show active" id="tabGenerate">

        <form id="cloForm" method="POST">

          <input type="hidden" name="profile" id="profileHidden" value="{{ profile }}">

          <div class="row g-3">

            <!-- COURSE + PLO -->
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <span class="icon-badge"><i class="bi bi-journal-text"></i></span>
                  Course & Mapping
                </div>
                <div class="card-body">

                  <label class="form-label">Course Code / Name *</label>
                  <input name="course" class="form-control" required>

                  <label class="form-label mt-3">PLO *</label>
                  <select name="plo" id="plo" class="form-select" required>
                    <option value="" disabled selected>Select PLO</option>
                    {% for p in plos %}
                      <option value="{{ p }}">{{ p }}</option>
                    {% endfor %}
                  </select>

                  <div class="row mt-3">
                    <div class="col-md-4">
                      <label class="form-label">SC Code</label>
                      <input id="sc_code" class="form-control" readonly>
                    </div>
                    <div class="col-md-8">
                      <label class="form-label">SC Description</label>
                      <input id="sc_desc" class="form-control" readonly>
                    </div>
                  </div>

                  <div class="row mt-3">
                    <div class="col-md-6">
                      <label class="form-label">VBE</label>
                      <input id="vbe" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Domain</label>
                      <input id="domain" class="form-control" readonly>
                    </div>
                  </div>

                </div>
              </div>
            </div>

            <!-- BLOOM + VERB -->
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <span class="icon-badge"><i class="bi bi-bar-chart-steps"></i></span>
                  Bloom & Verbs
                </div>
                <div class="card-body">

                  <label class="form-label">Bloom Level *</label>
                  <select id="bloom" name="bloom" class="form-select" required></select>

                  <label class="form-label mt-3">Verb *</label>
                  <select id="verb" name="verb" class="form-select" required></select>
                  <!-- BADGES for SC Code + Domain -->
<div id="mappingBadges" class="mt-2" style="display:none;">
   <span class="badge bg-primary me-2" id="badgeSC">SC: -</span>
   <span class="badge bg-dark" id="badgeDomain">Domain: -</span>
</div>


                </div>
              </div>
            </div>

            <!-- CLO BUILDER -->
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <span class="icon-badge"><i class="bi bi-pencil"></i></span>
                  CLO Builder
                </div>
                <div class="card-body">

                  <label class="form-label">Content / Object *</label>
                  <input name="content" class="form-control" required>

                  <div class="row mt-3">
                    <div class="col-md-4">
                      <label class="form-label">Condition</label>
                      <input id="condition" class="form-control" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Criterion</label>
                      <input id="criterion" class="form-control" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Assessment %</label>
                      <input name="cw" type="number" min="0" max="100" class="form-control">
                    </div>
                  </div>

                </div>
              </div>
            </div>

            <!-- ASSESSMENT -->
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <span class="icon-badge"><i class="bi bi-clipboard-check"></i></span>
                  Assessment
                </div>
                <div class="card-body">
                  <label class="form-label">Assessment Suggestion</label>
                  <input id="assessment" class="form-control" readonly>

                  <label class="form-label mt-3">Evidence of Assessment</label>
                  <input id="evidence" class="form-control" readonly>
                </div>
              </div>
            </div>

            <!-- ACTION BUTTONS -->
            <div class="col-12">
              <div class="sticky-actions d-flex justify-content-between">
                <div class="text-muted"><i class="bi bi-info-circle"></i> Complete fields then click Generate.</div>

                <div class="d-flex gap-2">
                  <a href="{{ url_for('reset_table') }}" class="btn btn-outline-danger">
                    <i class="bi bi-trash"></i> Reset History
                  </a>

                  <a href="{{ url_for('download') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-download"></i> Download
                  </a>

                  <button class="btn btn-primary">
                    <i class="bi bi-rocket-takeoff"></i> Generate
                  </button>
                </div>
              </div>
            </div>

          </div>
        </form>

       <!-- CLO PREVIEW CARD -->
<div class="card mt-4" id="cloPreviewCard" style="display:none;">
  <div class="card-header d-flex justify-content-between align-items-center">
      <div>
         <span class="icon-badge"><i class="bi bi-lightbulb"></i></span>
         Generated CLO
      </div>
      <button id="copyCLO" class="btn btn-sm btn-outline-primary">
         <i class="bi bi-clipboard"></i> Copy
      </button>
  </div>

  <div class="card-body">
    <p id="cloPreviewText" class="fs-5 fw-semibold text-primary"></p>
  </div>
</div>

      <!-- =================== HISTORY TAB =================== -->
      <div class="tab-pane fade" id="tabHistory">
        <div class="card mt-3">
          <div class="card-header">
            <span class="icon-badge"><i class="bi bi-clock-history"></i></span>
            CLO History
          </div>

          <div class="card-body">

            <div id="historyPlaceholder" class="text-center text-muted">
              <i class="bi bi-eye"></i> Click to load history.
              <div class="mt-2">
                <button id="loadHistoryBtn" class="btn btn-outline-primary btn-sm">Show History</button>
              </div>
            </div>

            <div id="historyArea" class="table-container" style="display:none;">
              <div id="historyHTML"></div>
            </div>

            <template id="serverTable">
              {{ table_html|safe }}
            </template>

          </div>
        </div>
      </div>

    </div>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- =============================================== -->
  <!--                MAIN JAVASCRIPT                 -->
  <!-- =============================================== -->
  <script>

    /* -------- Discipline Switch -------- */
    const profileSel = document.getElementById("profile");
    profileSel.value = "{{ profile }}";

    profileSel.addEventListener("change", () => {
      const v = profileSel.value;
      const url = new URL(window.location.href);
      if (v) url.searchParams.set("profile", v);
      else url.searchParams.delete("profile");
      window.location.href = url.toString();
    });

    function profileSuffix() {
      const p = profileSel.value;
      return p ? `?profile=${encodeURIComponent(p)}` : "";
    }

    /* -------- Fetch Helper -------- */
    async function fetchJSON(url) {
      const r = await fetch(url);
      if (!r.ok) return null;
      return await r.json();
    }

    /* -------- Elements -------- */
    const ploSel = document.getElementById("plo");
    const bloomSel = document.getElementById("bloom");
    const verbSel  = document.getElementById("verb");
    const scCode   = document.getElementById("sc_code");
    const scDesc   = document.getElementById("sc_desc");
    const vbe      = document.getElementById("vbe");
    const domain   = document.getElementById("domain");
    const condEl   = document.getElementById("condition");
    const critEl   = document.getElementById("criterion");
    const assessEl = document.getElementById("assessment");
    const evidEl   = document.getElementById("evidence");
    const profileHidden = document.getElementById("profileHidden");

    /* -------- Autofill PLO details -------- */
    async function refreshPLO(plo) {
      const info = await fetchJSON(`/api/debug_plo/${plo}${profileSuffix()}`);
      if (info && info.exists) {
        scCode.value = info.details.SC_Code || "";
        scDesc.value = info.details.SC_Desc || "";
        vbe.value    = info.details.VBE || "";
        domain.value = info.details.Domain || "";
      }
    }

    /* -------- Get Blooms -------- */
    async function refreshBlooms(plo) {
      bloomSel.innerHTML = '<option disabled selected>Select Bloom</option>';
      verbSel.innerHTML  = '<option disabled selected>Select Verb</option>';

      const blooms = await fetchJSON(`/api/get_blooms/${plo}${profileSuffix()}`) || [];
      blooms.forEach(b => {
        const opt = document.createElement("option");
        opt.value = opt.textContent = b;
        bloomSel.appendChild(opt);
      });
    }

    /* -------- Get Verbs -------- */
    async function refreshVerbs(plo, bloom) {
      verbSel.innerHTML = '<option disabled selected>Select Verb</option>';

      const verbs = await fetchJSON(`/api/get_verbs/${plo}/${bloom}${profileSuffix()}`) || [];
      verbs.forEach(v => {
        const opt = document.createElement("option");
        opt.value = opt.textContent = v;
        verbSel.appendChild(opt);
      });
    }

    /* -------- Criterion + Condition + Assessment + Evidence -------- */
    async function refreshMeta(plo, bloom) {
      const m = await fetchJSON(`/api/get_meta/${plo}/${bloom}${profileSuffix()}`);
      if (!m) return;
      condEl.value   = m.condition || "";
      critEl.value   = m.criterion || "";
      assessEl.value = m.assessment || "";
      evidEl.value   = m.evidence || "";
    }

    /* -------- Events -------- */
    ploSel.addEventListener("change", async () => {
      const p = ploSel.value;
      profileHidden.value = profileSel.value;

      await refreshPLO(p);
      await refreshBlooms(p);

      bloomSel.value = "";
      verbSel.value  = "";

      condEl.value = "";
      critEl.value = "";
      assessEl.value = "";
      evidEl.value = "";
    });

    bloomSel.addEventListener("change", async () => {
      const p = ploSel.value;
      const b = bloomSel.value;

      await refreshVerbs(p, b);
      await refreshMeta(p, b);
    });

    /* -------- AJAX Submit -------- */
    document.getElementById("cloForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      profileHidden.value = profileSel.value;

      const res = await fetch(`/generate${profileSuffix()}`, {
        method: "POST",
        body: new FormData(e.target)
      });

      const data = await res.json();
      if (data.error) return alert(data.error);

      document.getElementById("cloPreviewCard").style.display = "block";
      document.getElementById("cloPreviewText").innerText = data.clo;
    });

    /* -------- History Viewer -------- */
    document.getElementById("loadHistoryBtn")?.addEventListener("click", loadHistory);
    document.querySelector('[data-bs-target="#tabHistory"]')?.addEventListener("shown.bs.tab", loadHistory);

    function loadHistory() {
      const html = document.getElementById("serverTable").innerHTML;
      document.getElementById("historyHTML").innerHTML = html;
      document.getElementById("historyPlaceholder").style.display = "none";
      document.getElementById("historyArea").style.display = "block";
    }
/* =======================
   DARK MODE
=========================*/
const darkToggle = document.getElementById("darkToggle");
const root = document.documentElement;

// Load saved mode
if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
    root.classList.add("dark-mode");
}

// Toggle theme
darkToggle?.addEventListener("click", () => {
    const isDark = document.body.classList.toggle("dark-mode");
    root.classList.toggle("dark-mode");
    localStorage.setItem("theme", isDark ? "dark" : "light");
});
    /* =======================
   COPY CLO
=========================*/
document.getElementById("copyCLO")?.addEventListener("click", () => {
    const text = document.getElementById("cloPreviewText").innerText;
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById("copyCLO");
        btn.innerHTML = '<i class="bi bi-check2-circle"></i> Copied!';
        setTimeout(() => {
            btn.innerHTML = '<i class="bi bi-clipboard"></i> Copy';
        }, 1500);
    });
});


  </script>

</body>
</html>
