<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SCLOG Smart Course Learning Outcome Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap + Icons (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Your custom CSS -->
  <link href="{{ url_for('static', filename='custom.css') }}" rel="stylesheet" />
</head>

<body class="bg-soft">
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-brand py-3 shadow-sm">
    <div class="container">
      <span class="navbar-brand fw-semibold">
        <i class="bi bi-stars me-2"></i> SCLOG CLO Generator
      </span>

      <div class="ms-auto d-flex align-items-center gap-2">
        <label for="profile" class="text-white-50 mb-0 me-1 small">Discipline</label>
        <select id="profile" class="form-select form-select-sm">
          <option value="health">Medical & Health Sciences</option>
          <option value="sc">Computer Science & IT</option>
          <option value="eng">Engineering & Technology</option>
          <option value="socs">Social Sciences</option>
          <option value="edu">Education</option>
          <option value="bus">Business & Management</option>
          <option value="arts">Arts & Humanities</option>
        </select>
      </div>
    </div>
  </nav>

  <main class="container my-4">

    <!-- GENERATOR CARD -->
    <div class="card card-elev mb-4">
      <form id="cloForm" method="POST">
        <input type="hidden" id="profileHidden" name="profile" value="{{ profile }}" />

        <div class="card-body p-4">
          <div class="row g-4">
            <!-- Course & Mapping -->
            <div class="col-lg-6">
              <div class="card h-100">
                <div class="card-header bg-white border-0 fw-semibold">
                  <span class="icon-badge"><i class="bi bi-journal-text"></i></span>
                  Course & Mapping
                </div>
                <div class="card-body">
                  <label class="form-label">Course Code / Name *</label>
                  <input name="course" class="form-control" required />

                  <label class="form-label mt-3">PLO *</label>
                  <select id="plo" name="plo" class="form-select" required>
                    <option value="" disabled selected>Select PLO</option>
                    {% for p in plos %}
                      <option value="{{ p }}">{{ p }}</option>
                    {% endfor %}
                  </select>

                  <div class="row mt-3">
                    <div class="col-md-4">
                      <label class="form-label">SC Code</label>
                      <input id="sc_code" class="form-control" readonly />
                    </div>
                    <div class="col-md-8">
                      <label class="form-label">SC Description</label>
                      <input id="sc_desc" class="form-control" readonly />
                    </div>
                  </div>

                  <div class="row mt-3">
                    <div class="col-md-6">
                      <label class="form-label">VBE</label>
                      <input id="vbe" class="form-control" readonly />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Domain</label>
                      <input id="domain" class="form-control" readonly />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bloom & Verbs -->
            <div class="col-lg-6">
              <div class="card h-100">
                <div class="card-header bg-white border-0 fw-semibold">
                  <span class="icon-badge"><i class="bi bi-layers"></i></span>
                  Bloom & Verbs
                </div>
                <div class="card-body">
                  <label class="form-label">Bloom Level *</label>
                  <select id="bloom" name="bloom" class="form-select" required></select>

                  <label class="form-label mt-3">Verb *</label>
                  <select id="verb" name="verb" class="form-select" required></select>

                  <label class="form-label mt-3">VBE Phrase Style</label>
                  <select id="vbe_style" name="vbe_style" class="form-select">
                    <option value="guided" selected>guided by …</option>
                    <option value="accordance">in accordance with …</option>
                    <option value="aligned">aligned with …</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- CLO Builder -->
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-white border-0 fw-semibold">
                  <span class="icon-badge"><i class="bi bi-pencil"></i></span>
                  CLO Builder
                </div>
                <div class="card-body">
                  <label class="form-label">Content *</label>
                  <input name="content" class="form-control" placeholder="e.g., ECG waveforms" required />

                  <div class="row mt-3">
                    <div class="col-md-4">
                      <label class="form-label">Condition</label>
                      <input id="condition" class="form-control" readonly />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Criterion</label>
                      <input id="criterion" class="form-control" readonly />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Assessment %</label>
                      <input type="number" name="cw" min="0" max="100" class="form-control" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Assessment & Actions -->
            <div class="col-12">
              <div class="card">
                <div class="card-header bg-white border-0 fw-semibold">
                  <span class="icon-badge"><i class="bi bi-clipboard-check"></i></span>
                  Assessment
                </div>
                <div class="card-body">
                  <label class="form-label">Assessment</label>
                  <input id="assessment" class="form-control" readonly />

                  <label class="form-label mt-3">Evidence</label>
                  <input id="evidence" class="form-control" readonly />

                  <div class="d-flex justify-content-between flex-wrap gap-2 mt-4">
                    <div class="btn-group">
                      <a href="/download" class="btn btn-outline-success">
                        <i class="bi bi-download"></i> Download CLO Table
                      </a>
                      <a href="/download_rubric" class="btn btn-outline-secondary">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Download Rubric
                      </a>
                    </div>

                    <button type="submit" class="btn btn-brand">
                      <i class="bi bi-magic"></i> Generate CLO
                    </button>
                  </div>
                </div>
              </div>
            </div>

          </div> <!-- /row -->
        </div> <!-- /card-body -->
      </form>
    </div>

    <!-- CLO Preview (Main + One Alternative) -->
    <div class="card card-elev mt-3" id="cloPreviewCard" style="display:none;">
      <div class="card-header bg-white border-0 fw-semibold d-flex justify-content-between align-items-center">
        <div>
          <span class="icon-badge"><i class="bi bi-lightbulb"></i></span>
          Generated CLO
        </div>
        <button id="copyCloBtn" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-clipboard"></i> Copy
        </button>
      </div>
      <div class="card-body">
        <p id="cloPreviewText" class="lead mb-3"></p>
        <div class="small text-muted mb-2">Alternative:</div>
        <div id="altOptions"></div>
      </div>
    </div>

    <!-- Rubric -->
    <div class="card card-elev mt-3" id="rubricCard" style="display:none;">
      <div class="card-header bg-white border-0 fw-semibold">
        <span class="icon-badge"><i class="bi bi-list-check"></i></span>
        CLO Rubric
      </div>
      <div class="card-body">
        <table class="table table-bordered mb-0">
          <tr><th>Indicator</th><td id="r_indicator"></td></tr>
          <tr><th>Excellent</th><td id="r_excellent"></td></tr>
          <tr><th>Good</th><td id="r_good"></td></tr>
          <tr><th>Satisfactory</th><td id="r_satisfactory"></td></tr>
          <tr><th>Poor</th><td id="r_poor"></td></tr>
        </table>
      </div>
    </div>

  </main>

  <!-- FOOTER -->
 <footer class="text-center mt-5 mb-4 small text-muted">
  <strong>SCLOG Generator</strong><br>
  Developed by Assoc. Prof. Dr. Hazwani Ahmad Yusof@Hanafi<br>
  Advanced Medical and Dental Institute (AMDI), Universiti Sains Malaysia (USM)
</footer>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /* ============== ELEMENTS ============== */
  const profileSel   = document.getElementById('profile');
  const profileHidden= document.getElementById('profileHidden');
  const ploSel       = document.getElementById('plo');
  const bloomSel     = document.getElementById('bloom');
  const verbSel      = document.getElementById('verb');

  const scCode = document.getElementById('sc_code');
  const scDesc = document.getElementById('sc_desc');
  const vbe    = document.getElementById('vbe');
  const domain = document.getElementById('domain');

  const condEl   = document.getElementById('condition');
  const critEl   = document.getElementById('criterion');
  const assessEl = document.getElementById('assessment');
  const evidEl   = document.getElementById('evidence');

  const form = document.getElementById('cloForm');

  /* ============== DISCIPLINE PLACEHOLDER ============== */
  const contentInput = document.querySelector('input[name="content"]');
  const contentPlaceholderMap = {
    "": ["e.g., ECG waveforms","e.g., respiratory function indicators","e.g., exercise metabolism responses"],
    "health": ["e.g., ECG waveforms","e.g., patient functional assessment data","e.g., clinical exercise prescription parameters"],
    "sc": ["e.g., algorithm complexity results","e.g., API response logs","e.g., software test cases"],
    "eng": ["e.g., circuit load measurements","e.g., CAD model specifications","e.g., stress-strain datasets"],
    "socs": ["e.g., demographic survey datasets","e.g., community behavioural indicators","e.g., qualitative interview themes"],
    "edu": ["e.g., lesson plan structure","e.g., student learning profiles","e.g., assessment rubric elements"],
    "bus": ["e.g., financial ratio trends","e.g., market segmentation data","e.g., strategic planning frameworks"],
    "arts": ["e.g., colour theory elements","e.g., visual composition structures","e.g., creative conceptual briefs"]
  };
  function updateContentPlaceholder() {
    const profile = profileSel.value || "";
    const options = contentPlaceholderMap[profile] || ["Enter content here"];
    contentInput.placeholder = options[Math.floor(Math.random()*options.length)];
  }
  profileSel.addEventListener("change", () => {
    // also refresh page query so backend uses mapped sheet
    const url = new URL(window.location.href);
    if (profileSel.value) url.searchParams.set('profile', profileSel.value);
    else url.searchParams.delete('profile');
    window.location.href = url.toString();
  });
  // run once on load
  updateContentPlaceholder();

  /* ============== HELPERS ============== */
  function suffix() {
    const p = profileHidden.value || profileSel.value;
    return p ? `?profile=${encodeURIComponent(p)}` : "";
  }
  async function fetchJSON(url) {
    const r = await fetch(url);
    return r.ok ? r.json() : null;
  }

  /* ============== DROPDOWNS ============== */
  async function refreshBlooms(plo) {
    bloomSel.innerHTML = '<option disabled selected>Select Bloom</option>';
    verbSel.innerHTML  = '<option disabled selected>Select Verb</option>';
    const data = await fetchJSON(`/api/get_blooms/${encodeURIComponent(plo)}${suffix()}`);
    if (data) data.forEach(b => {
      const opt = document.createElement('option');
      opt.value = opt.textContent = b;
      bloomSel.appendChild(opt);
    });
  }

  async function refreshVerbs(plo, bloom) {
    verbSel.innerHTML = '<option disabled selected>Select Verb</option>';
    const data = await fetchJSON(`/api/get_verbs/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}${suffix()}`);
    if (data) data.forEach(v => {
      const opt = document.createElement('option');
      opt.value = opt.textContent = v;
      verbSel.appendChild(opt);
    });
  }

  async function refreshMeta(plo, bloom) {
    const m = await fetchJSON(`/api/get_meta/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}${suffix()}`);
    if (!m) return;
    scCode.value = m.sc_code || "";
    scDesc.value = m.sc_desc || "";
    vbe.value    = m.vbe    || "";
    domain.value = m.domain || "";
    condEl.value = m.condition || "";
    critEl.value = m.criterion || "";
    assessEl.value = m.assessment || "";
    evidEl.value   = m.evidence   || "";
  }

  /* ============== EVENTS ============== */
  ploSel.addEventListener('change', async () => {
    profileHidden.value = profileSel.value;
    await refreshBlooms(ploSel.value);
    bloomSel.value = ""; verbSel.value = "";
    condEl.value = critEl.value = assessEl.value = evidEl.value = "";
    document.getElementById('cloPreviewCard').style.display = 'none';
  });

  bloomSel.addEventListener('change', async () => {
    await refreshVerbs(ploSel.value, bloomSel.value);
    await refreshMeta(ploSel.value, bloomSel.value);
  });

  /* ============== RUBRIC VIEW ============== */
  function populateRubric(r) {
    if (!r) return;
    document.getElementById('rubricCard').style.display = 'block';
    document.getElementById('r_indicator').innerText    = r.indicator || "";
    document.getElementById('r_excellent').innerText    = r.excellent || "";
    document.getElementById('r_good').innerText         = r.good || "";
    document.getElementById('r_satisfactory').innerText = r.satisfactory || "";
    document.getElementById('r_poor').innerText         = r.poor || "";
  }

  /* ============== SUBMIT ============== */
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const resp = await fetch("/generate" + suffix(), { method: "POST", body: new FormData(form) });
    const data = await resp.json();
    // CLO main
    document.getElementById('cloPreviewCard').style.display = 'block';
    document.getElementById('cloPreviewText').innerText = data.clo || "";
    // One alternative only
    const alt = document.getElementById('altOptions');
    alt.innerHTML = "";
    const variants = data.clo_options || {};
    Object.keys(variants).slice(0,1).forEach((name) => {
      const txt = variants[name];
      const div = document.createElement("div");
      div.className = "option";
      div.innerText = txt;
      div.onclick = () => {
        document.querySelectorAll("#altOptions .option").forEach(n => n.classList.remove("active-option"));
        div.classList.add("active-option");
        document.getElementById('cloPreviewText').innerText = txt;
      };
      alt.appendChild(div);
    });
    // Rubric + assessment
    populateRubric(data.rubric);
    assessEl.value = data.assessment || "";
    evidEl.value   = data.evidence   || "";
  });

  /* ============== COPY ============== */
  document.getElementById('copyCloBtn').addEventListener('click', async () => {
    const text = (document.getElementById('cloPreviewText').innerText || "").trim();
    if (!text) return;
    try { await navigator.clipboard.writeText(text); } catch {}
  });
  </script>
</body>
</html>
