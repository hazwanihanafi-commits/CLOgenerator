<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SCLOG Smart CLO Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HMBYNXRLBE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-HMBYNXRLBE');
  </script>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Optional custom CSS -->
  <link href="{{ url_for('static', filename='custom.css') }}" rel="stylesheet" />

  <style>
    /* Minor local styles for readability */
    .card-elev { border-radius: 12px; box-shadow: 0 6px 18px rgba(23,102,216,0.06); }
    .bg-brand { background: linear-gradient(90deg,#1158c7,#1b7de6); }
    .loader { display:inline-block; width:16px; height:16px; border:2px solid #e9f2ff; border-top-color:#1766d8; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .variant-item { background:#fff; border:1px solid #eef4ff; border-radius:8px; padding:10px; margin-bottom:8px; }
    .muted-small { color:#6b7280; font-size:0.95rem; }
    .meta-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:10px; }
    .meta-card { background:#fff; border:1px solid #f0f4ff; padding:10px; border-radius:8px; }
  </style>
</head>
<body class="bg-light">

  <!-- NAV -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-brand py-3">
    <div class="container">
      <span class="navbar-brand fw-bold"><i class="bi bi-stars me-2"></i> SCLOG — Smart CLO Generator</span>
      <div class="ms-auto d-flex align-items-center gap-2">
        <label class="text-white-50 small mb-0 me-2">Profile</label>
        <select id="profile" class="form-select form-select-sm">
          <option value="health">Medical & Health Sciences</option>
          <option value="sc">Computer Science & IT</option>
          <option value="eng">Engineering & Technology</option>
          <option value="socs">Social Sciences</option>
          <option value="edu">Education</option>
          <option value="bus">Business & Management</option>
          <option value="arts">Arts & Humanities</option>
        </select>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <div class="card card-elev">
      <form id="cloForm" method="post" class="p-3">
        <input type="hidden" id="profileHidden" name="profile" />
        <div class="row g-4">

          <!-- LEFT: Mapping / PLO -->
          <div class="col-lg-5">
            <div class="card p-3 h-100">
              <h5 class="mb-3">Course & Mapping</h5>

              <div class="mb-2">
                <label class="form-label">Course (code / name)</label>
                <input name="course" class="form-control" placeholder="e.g., CLIN101 - Clinical Skills" />
              </div>

              <div class="mb-2">
                <label class="form-label">Level</label>
                <select id="level" name="level" class="form-select">
                  <option>Degree</option>
                  <option>Diploma</option>
                  <option>Master</option>
                  <option>PhD</option>
                </select>
              </div>

              <!-- IEG / PEO / PLO -->
              <div class="mb-2">
                <label class="form-label">IEG</label>
                <select id="ieg" class="form-select">
                  <option value="">— Select IEG —</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label">PEO</label>
                <select id="peo" class="form-select">
                  <option value="">— Select PEO —</option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label">PLO</label>
                <select id="plo" name="plo" class="form-select" required>
                  <option value="">— Select PLO —</option>
                </select>
              </div>

              <!-- mapping summary -->
              <div class="mt-3">
                <div class="meta-grid">
                  <div class="meta-card">
                    <div class="text-muted-small">SC Code</div>
                    <div id="sc_code" class="fw-semibold"></div>
                  </div>
                  <div class="meta-card">
                    <div class="text-muted-small">SC Description</div>
                    <div id="sc_desc" class="fw-semibold"></div>
                  </div>
                  <div class="meta-card">
                    <div class="text-muted-small">VBE</div>
                    <div id="vbe" class="fw-semibold"></div>
                  </div>
                  <div class="meta-card">
                    <div class="text-muted-small">Domain</div>
                    <div id="domain" class="fw-semibold"></div>
                  </div>
                </div>
              </div>

              <!-- IEG/PEO/PLO statements + indicator -->
              <div class="alert alert-light mt-3">
                <div class="mb-1"><strong>IEG Statement:</strong> <span id="ieg_statement" class="muted-small">—</span></div>
                <div class="mb-1"><strong>PEO Statement:</strong> <span id="peo_statement" class="muted-small">—</span></div>
                <div class="mb-1"><strong>PLO Statement:</strong> <span id="plo_statement" class="muted-small">—</span></div>
                <div class="mb-1"><strong>PLO Indicator:</strong> <span id="plo_indicator" class="muted-small">—</span></div>
              </div>

              <div class="d-flex gap-2 mt-3">
                <a href="/download" class="btn btn-outline-success btn-sm"><i class="bi bi-download me-1"></i> Download CLO Table</a>
                <a href="/download_rubric" class="btn btn-outline-secondary btn-sm"><i class="bi bi-file-earmark-text me-1"></i> Download Rubric</a>
              </div>
            </div>
          </div>

          <!-- RIGHT: Bloom & CLO builder -->
          <div class="col-lg-7">
            <div class="card p-3 h-100">
              <h5 class="mb-3">Bloom & CLO Builder</h5>

              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">Bloom</label>
                  <select id="bloom" name="bloom" class="form-select" required>
                    <option value="">— Select Bloom —</option>
                  </select>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Verb</label>
                  <select id="verb" name="verb" class="form-select" required>
                    <option value="">— Select Verb —</option>
                  </select>
                </div>

                <div class="col-12 mt-2">
                  <label class="form-label">Content (topic / object)</label>
                  <input id="content" name="content" class="form-control" placeholder="e.g., interpret ECG waveforms, design an intervention plan" required />
                </div>

                <div class="col-md-6 mt-2">
                  <label class="form-label">Condition</label>
                  <input id="condition" name="condition" class="form-control" readonly />
                </div>

                <div class="col-md-6 mt-2">
                  <label class="form-label">Criterion</label>
                  <input id="criterion" name="criterion" class="form-control" readonly />
                </div>

                <div class="col-md-6 mt-2">
                  <label class="form-label">Coursework %</label>
                  <input id="cw" name="cw" type="number" min="0" max="100" class="form-control" placeholder="e.g., 40" />
                </div>

                <div class="col-12 mt-3 d-flex align-items-center gap-2">
                  <button id="generateBtn" type="button" class="btn btn-primary"><i class="bi bi-magic me-1"></i> Generate CLO</button>
                  <div id="busy" style="display:none;"><span class="loader"></span> Generating…</div>
                </div>

                <!-- Preview area -->
                <div class="col-12 mt-3" id="previewPanel" style="display:none;">
                  <div class="card card-elev p-3">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <h6 class="mb-1">Generated CLO</h6>
                        <div id="cloPreviewText" class="fw-semibold"></div>
                      </div>
                      <div class="text-end">
                        <button id="copyCloBtn" class="btn btn-outline-secondary btn-sm"><i class="bi bi-clipboard"></i> Copy</button>
                      </div>
                    </div>

                    <div class="mt-3 d-flex justify-content-between align-items-center">
                      <div>
                        <small class="text-muted">Alternative variants</small>
                      </div>
                      <button id="toggleVariants" class="btn btn-sm btn-outline-primary">Show variants</button>
                    </div>

                    <div id="variantsPanel" style="display:none; margin-top:10px;"></div>
                  </div>
                </div>

                <!-- Rubric -->
                <div class="col-12 mt-3" id="rubricPanel" style="display:none;">
                  <div class="card card-elev p-3">
                    <h6 class="mb-2">Rubric</h6>
                    <div class="table-responsive">
                      <table class="table table-sm">
                        <tr><th>Indicator</th><td id="r_indicator"></td></tr>
                        <tr><th>Excellent</th><td id="r_excellent"></td></tr>
                        <tr><th>Good</th><td id="r_good"></td></tr>
                        <tr><th>Satisfactory</th><td id="r_satisfactory"></td></tr>
                        <tr><th>Poor</th><td id="r_poor"></td></tr>
                      </table>
                    </div>
                  </div>
                </div>

              </div> <!-- row -->
            </div> <!-- card -->
          </div>

        </div> <!-- row -->
      </form>
    </div>
  </main>

  <footer class="text-center small text-muted mb-4">
    SCLOG Generator — Developed by Assoc. Prof. Dr. Hazwani Ahmad Yusof @ USM
  </footer>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <!-- Optional advanced auto-linker if you use it -->
  <script src="/static/js/advanced_clo_generator_v3.js" defer></script>

  <script>
  // === Utility helpers ===
  const $ = id => document.getElementById(id);
  const profileSel = $('profile');
  const profileHidden = $('profileHidden');
  const iegSel = $('ieg');
  const peoSel = $('peo');
  const ploSel = $('plo');
  const levelSel = $('level');

  const bloomSel = $('bloom');
  const verbSel = $('verb');
  const contentInput = $('content');

  const scCodeEl = $('sc_code');
  const scDescEl = $('sc_desc');
  const vbeEl = $('vbe');
  const domainEl = $('domain');

  const conditionEl = $('condition');
  const criterionEl = $('criterion');
  const cwEl = $('cw');

  const iegStatementEl = $('ieg_statement');
  const peoStatementEl = $('peo_statement');
  const ploStatementEl = $('plo_statement');
  const ploIndicatorEl = $('plo_indicator');

  const generateBtn = $('generateBtn');
  const busyEl = $('busy');

  const previewPanel = $('previewPanel');
  const cloPreviewText = $('cloPreviewText');
  const copyCloBtn = $('copyCloBtn');
  const toggleVariantsBtn = $('toggleVariants');
  const variantsPanel = $('variantsPanel');

  const rubricPanel = $('rubricPanel');
  const r_indicator = $('r_indicator');
  const r_excellent = $('r_excellent');
  const r_good = $('r_good');
  const r_satisfactory = $('r_satisfactory');
  const r_poor = $('r_poor');

  // location-based profile from ?profile=...
  (function initProfileFromURL(){
    const params = new URLSearchParams(window.location.search);
    const p = params.get('profile');
    if (p) {
      profileSel.value = p;
      profileHidden.value = p;
    } else {
      profileHidden.value = profileSel.value;
    }
  })();

  // small helper for fetch JSON
  async function fetchJSON(url, opts){
    const res = await fetch(url, opts);
    if (!res.ok) throw new Error('Fetch error ' + res.status);
    return res.json();
  }

  // === Load IEGs & base PLO list from static mapping ===
  async function loadIEGandPLOs(){
    try {
      const map = await fetchJSON('/static/data/peo_plo_ieg.json');
      // IEGs
      iegSel.innerHTML = '<option value="">— Select IEG —</option>';
      (map.IEGs || []).forEach(i => iegSel.append(new Option(i,i)));
      // PLO master list (fallback)
      ploSel.innerHTML = '<option value="">— Select PLO —</option>';
      (map.PLOs || []).forEach(p => ploSel.append(new Option(p,p)));
    } catch (e){
      console.warn('Failed loading mapping JSON', e);
    }
  }

  // IEG -> load PEOs
  iegSel.addEventListener('change', async () => {
    const ieg = iegSel.value;
    peoSel.innerHTML = '<option value="">Loading…</option>';
    ploSel.innerHTML = '<option value="">— Select PLO —</option>'; // reset
    try {
      const peos = await fetchJSON(`/api/get_peos/${encodeURIComponent(ieg)}`);
      peoSel.innerHTML = '<option value="">— Select PEO —</option>';
      (peos || []).forEach(p => peoSel.append(new Option(p,p)));
      // clear statements
      peoStatementEl.textContent = '—';
      ploStatementEl.textContent = '—';
      ploIndicatorEl.textContent = '—';
      iegStatementEl.textContent = ieg || '—';
    } catch (e) {
      peoSel.innerHTML = '<option value="">— Error loading PEOs —</option>';
      console.error(e);
    }
  });

  // PEO -> load PLOs
  peoSel.addEventListener('change', async () => {
    const peo = peoSel.value;
    ploSel.innerHTML = '<option value="">Loading…</option>';
    try {
      const plos = await fetchJSON(`/api/get_plos/${encodeURIComponent(peo)}`);
      ploSel.innerHTML = '<option value="">— Select PLO —</option>';
      (plos || []).forEach(p => ploSel.append(new Option(p,p)));
      // load PEO statement for selected level (if available)
      const level = levelSel.value || 'Degree';
      if (peo) {
        try {
          const txt = await fetchJSON(`/api/get_statement/${encodeURIComponent(level)}/PEO/${encodeURIComponent(peo)}`);
          peoStatementEl.textContent = txt || '—';
        } catch(e){ peoStatementEl.textContent = '—'; }
      }
      // reset PLO statement
      ploStatementEl.textContent = '—';
      ploIndicatorEl.textContent = '—';
    } catch (e) {
      ploSel.innerHTML = '<option value="">— Error loading PLOs —</option>';
      console.error(e);
    }
  });

  // PLO changed -> load blooms & statements & indicator
  ploSel.addEventListener('change', async () => {
    const plo = ploSel.value;
    // clear previous
    bloomSel.innerHTML = '<option value="">— Select Bloom —</option>';
    verbSel.innerHTML = '<option value="">— Select Verb —</option>';
    scCodeEl.textContent = scDescEl.textContent = vbeEl.textContent = domainEl.textContent = '';
    conditionEl.value = criterionEl.value = '';
    iegStatementEl.textContent = iegSel.value || '—';

    if (!plo) return;

    // load blooms
    try {
      const blooms = await fetchJSON(`/api/get_blooms/${encodeURIComponent(plo)}?profile=${encodeURIComponent(profileHidden.value || profileSel.value)}`);
      bloomSel.innerHTML = '<option value="">— Select Bloom —</option>';
      (blooms || []).forEach(b => bloomSel.append(new Option(b,b)));
    } catch(e){
      console.error('blooms', e);
    }

    // PLO statement & indicator (for selected level)
    const level = levelSel.value || 'Degree';
    try {
      const ploStmt = await fetchJSON(`/api/get_statement/${encodeURIComponent(level)}/PLO/${encodeURIComponent(plo)}`);
      ploStatementEl.textContent = ploStmt || '—';
    } catch(e){ ploStatementEl.textContent = '—'; }

    try {
      const ind = await fetchJSON(`/api/get_indicator/${encodeURIComponent(plo)}`);
      ploIndicatorEl.textContent = ind || '—';
    } catch(e){ ploIndicatorEl.textContent = '—'; }

    // attempt to auto-load PEO if not selected (helpful)
    if (!peoSel.value) {
      try {
        const map = await fetchJSON('/static/data/peo_plo_ieg.json');
        for (const [peo, arr] of Object.entries(map.PEOtoPLO || {})) {
          if (Array.isArray(arr) && arr.includes(plo)) {
            // set peo, then attempt to load statement
            peoSel.value = peo;
            const peoStmt = await fetchJSON(`/api/get_statement/${encodeURIComponent(level)}/PEO/${encodeURIComponent(peo)}`);
            peoStatementEl.textContent = peoStmt || '—';
            break;
          }
        }
      } catch(e){ /* ignore */ }
    }
  });

  // Bloom -> load verbs + meta (criterion/condition/assessment/evidence)
  bloomSel.addEventListener('change', async () => {
    const bloom = bloomSel.value;
    const plo = ploSel.value;
    if (!bloom || !plo) return;

    // verbs
    try {
      const verbs = await fetchJSON(`/api/get_verbs/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}?profile=${encodeURIComponent(profileHidden.value || profileSel.value)}`);
      verbSel.innerHTML = '<option value="">— Select Verb —</option>';
      (verbs || []).forEach(v => verbSel.append(new Option(v,v)));
    } catch(e){ console.error(e); }

    // meta
    try {
      const meta = await fetchJSON(`/api/get_meta/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}?profile=${encodeURIComponent(profileHidden.value || profileSel.value)}`);
      scCodeEl.textContent = meta.sc_code || '';
      scDescEl.textContent = meta.sc_desc || '';
      vbeEl.textContent = meta.vbe || '';
      domainEl.textContent = meta.domain || '';
      conditionEl.value = meta.condition || '';
      criterionEl.value = meta.criterion || '';
      // (assessment/evidence are returned to the preview after generate)
    } catch(e){ console.error('meta', e); }
  });

  // verb change: nothing heavy, but we will update the live preview indicator if present
  verbSel.addEventListener('change', () => {
    // no-op; generate button will build rubric indicator via backend
  });

  // load initial data
  loadIEGandPLOs();

  // profile change (re-navigate to same page with ?profile= or simply set hidden)
  profileSel.addEventListener('change', () => {
    profileHidden.value = profileSel.value;
    // update URL param for shareability (keeps browser history friendly)
    const url = new URL(window.location.href);
    url.searchParams.set('profile', profileSel.value);
    window.history.replaceState({}, '', url.toString());
  });

  // === Generate CLO (POST) ===
  generateBtn.addEventListener('click', async () => {
    // validation
    if (!ploSel.value || !bloomSel.value || !verbSel.value || !contentInput.value.trim()) {
      alert('Please select PLO, Bloom, Verb and provide Content.');
      return;
    }

    // show busy
    busyEl.style.display = 'inline-block';
    generateBtn.disabled = true;

    try {
      const fd = new FormData();
      fd.append('plo', ploSel.value);
      fd.append('bloom', bloomSel.value);
      fd.append('verb', verbSel.value);
      fd.append('content', contentInput.value.trim());
      fd.append('course', document.querySelector('input[name="course"]').value || '');
      fd.append('cw', cwEl.value || '');
      fd.append('vbe_style', document.getElementById('vbe_style') ? document.getElementById('vbe_style').value : 'guided');
      fd.append('level', levelSel.value || 'Degree');
      fd.append('profile', profileHidden.value || profileSel.value);

      const res = await fetch('/generate?profile=' + encodeURIComponent(profileHidden.value || profileSel.value), {
        method: 'POST', body: fd
      });

      if (!res.ok) {
        const err = await res.json().catch(()=>({error:'Server error'}));
        throw new Error(err.error || 'Failed to generate');
      }

      const data = await res.json();

      // preview
      previewPanel.style.display = 'block';
      cloPreviewText.innerText = data.clo || '';

      // variants
      variantsPanel.innerHTML = '';
      const clo_options = data.clo_options || {};
      for (const [label, text] of Object.entries(clo_options)) {
        const div = document.createElement('div');
        div.className = 'variant-item';
        div.innerHTML = `<strong>${label}</strong><div class="mt-1">${text}</div>`;
        div.onclick = () => cloPreviewText.innerText = text;
        variantsPanel.appendChild(div);
      }

      // rubric
      if (data.rubric) {
        rubricPanel.style.display = 'block';
        r_indicator.innerText = data.rubric.indicator || '';
        r_excellent.innerText = data.rubric.excellent || '';
        r_good.innerText = data.rubric.good || '';
        r_satisfactory.innerText = data.rubric.satisfactory || '';
        r_poor.innerText = data.rubric.poor || '';
      }

      // assessment & evidence fill local fields
      // backend returns assessment/evidence in response; update UI fields
      if (data.assessment) {
        $('assessment').value = data.assessment;
      }
      if (data.evidence) {
        $('evidence').value = data.evidence;
      }

      // update statements & indicator in UI (returned by backend)
      iegStatementEl.textContent = data.ieg || iegStatementEl.textContent || '—';
      peoStatementEl.textContent = data.peo || peoStatementEl.textContent || '—';
      ploStatementEl.textContent = data.plo_statement || ploStatementEl.textContent || '—';
      ploIndicatorEl.textContent = data.plo_indicator || ploIndicatorEl.textContent || '—';

      // mapping
      scCodeEl.textContent = data.sc_code || scCodeEl.textContent;
      scDescEl.textContent = data.sc_desc || scDescEl.textContent;
      vbeEl.textContent = data.vbe || vbeEl.textContent;

      // GA event
      try {
        gtag('event', 'clo_generated', {
          profile: profileHidden.value || profileSel.value,
          plo: ploSel.value,
          bloom: bloomSel.value
        });
      } catch(e){}

    } catch (err) {
      console.error(err);
      alert('Error: ' + (err.message || 'Failed to generate CLO'));
    } finally {
      busyEl.style.display = 'none';
      generateBtn.disabled = false;
    }
  });

  // toggle variants
  toggleVariantsBtn.addEventListener('click', () => {
    const hidden = variantsPanel.style.display === 'none' || variantsPanel.style.display === '';
    variantsPanel.style.display = hidden ? 'block' : 'none';
    toggleVariantsBtn.innerHTML = hidden ? 'Hide variants' : 'Show variants';
  });

  // copy preview
  copyCloBtn.addEventListener('click', async () => {
    const text = cloPreviewText.innerText;
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      copyCloBtn.innerText = 'Copied';
      setTimeout(()=> copyCloBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copy', 1500);
    } catch(e){
      alert('Copy failed');
    }
  });

  // quick helper for element by id in runtime scope
  function $(id){ return document.getElementById(id); }

  // expose a small debug helper globally (optional)
  window.SCLOG = {
    loadIEGandPLOs
  };

  // initialize
  loadIEGandPLOs();

  </script>
</body>
</html>
