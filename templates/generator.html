<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CLO Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 5 + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background: #f7f9fb; }
    .brand { font-weight: 700; letter-spacing: .5px; }
    .card { border: 0; border-radius: 1rem; box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .card .card-header { border-bottom: 0; background: transparent; font-weight: 600; }
    .icon-badge {
      width: 40px; height: 40px; border-radius: 10px;
      display: inline-flex; align-items: center; justify-content: center;
      background: #eef5ff; color: #2b6cb0; margin-right: .5rem;
    }
    .nav-pills .nav-link.active { background: #2b6cb0; }
    .muted { color:#6b7280; }
    .sticky-actions { position: sticky; bottom: 0; background: #fff; padding: 1rem; box-shadow: 0 -6px 16px rgba(0,0,0,.05); border-radius: 1rem; }
    .spinner { display: none; }
    .form-label .req { color:#dc3545; }
    .help { font-size:.875rem; color:#6b7280; }
    .table-wrap { overflow:auto; }
    .tab-pane { padding-top: 1rem; }
  </style>
</head>
<body>
  <nav class="navbar navbar-light bg-white border-bottom">
    <div class="container">
      <a class="navbar-brand brand" href="#"><i class="bi bi-diagram-3 me-2"></i>CLO Generator</a>
      <div class="d-flex align-items-center gap-3">
        <!-- Discipline / profile switch -->
        <form id="profileForm" class="d-flex align-items-center">
          <label class="me-2 muted">Discipline</label>
          <select id="profile" name="profile" class="form-select form-select-sm">
            <option value="">Default (Health)</option>
            <option value="cs" {{ 'selected' if profile=='cs' else '' }}>Computer Science</option>
            <option value="eng" {{ 'selected' if profile=='eng' else '' }}>Engineering</option>
            <option value="soc" {{ 'selected' if profile=='soc' else '' }}>Social Science</option>
          </select>
        </form>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <!-- Tabs -->
    <ul class="nav nav-pills" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="gen-tab" data-bs-toggle="pill" data-bs-target="#gen" type="button" role="tab">
          <i class="bi bi-magic me-1"></i> Generate CLO
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="hist-tab" data-bs-toggle="pill" data-bs-target="#hist" type="button" role="tab">
          <i class="bi bi-table me-1"></i> History
        </button>
      </li>
    </ul>

    <div class="tab-content" id="tabsContent">
      <!-- Generate CLO -->
      <div class="tab-pane fade show active" id="gen" role="tabpanel" aria-labelledby="gen-tab">
        <form method="post" action="{{ url_for('generate') }}" id="cloForm" class="mt-3">

          <div class="row g-3">
            <!-- Course & PLO -->
            <div class="col-12 col-lg-6">
              <div class="card">
                <div class="card-header d-flex align-items-center">
                  <span class="icon-badge"><i class="bi bi-journal-text"></i></span>
                  <div>Course & Mapping</div>
                </div>
                <div class="card-body">

                  <div class="mb-3">
                    <label class="form-label">Course Code / Name <span class="req">*</span></label>
                    <input type="text" class="form-control" name="course" placeholder="e.g., Programming 101" required>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">PLO (select) <span class="req">*</span></label>
                    <select class="form-select" id="plo" name="plo" required>
                      <option value="" selected disabled>Choose PLO…</option>
                      {% for p in plos %}
                        <option value="{{ p }}">{{ p }}</option>
                      {% endfor %}
                    </select>
                    <div class="help">PLO drives Domain and Bloom options.</div>
                  </div>

                  <div class="row g-2">
                    <div class="col-md-4">
                      <label class="form-label">SC Code</label>
                      <input type="text" class="form-control" id="sc_code" placeholder="auto" readonly>
                    </div>
                    <div class="col-md-8">
                      <label class="form-label">SC Description</label>
                      <input type="text" class="form-control" id="sc_desc" placeholder="auto" readonly>
                    </div>
                  </div>

                  <div class="row g-2 mt-2">
                    <div class="col-md-6">
                      <label class="form-label">VBE</label>
                      <input type="text" class="form-control" id="vbe" placeholder="auto" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Domain</label>
                      <input type="text" class="form-control" id="domain" placeholder="auto" readonly>
                    </div>
                  </div>

                </div>
              </div>
            </div>

            <!-- Bloom & Verb -->
            <div class="col-12 col-lg-6">
              <div class="card">
                <div class="card-header d-flex align-items-center">
                  <span class="icon-badge"><i class="bi bi-layers"></i></span>
                  <div>Bloom & Verbs</div>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label">Bloom Level <span class="req">*</span></label>
                    <select class="form-select" id="bloom" name="bloom" required>
                      <option value="" selected disabled>Choose Bloom…</option>
                    </select>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Verb (auto) <span class="req">*</span></label>
                    <select class="form-select" id="verb" name="verb" required>
                      <option value="" selected disabled>Choose Verb…</option>
                    </select>
                    <div class="spinner mt-2" id="verbSpinner">
                      <div class="text-secondary"><i class="bi bi-arrow-repeat me-1"></i>Loading verbs…</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Content & Conditions -->
            <div class="col-12">
              <div class="card">
                <div class="card-header d-flex align-items-center">
                  <span class="icon-badge"><i class="bi bi-pencil-square"></i></span>
                  <div>CLO Builder</div>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Content / Object <span class="req">*</span></label>
                      <input type="text" class="form-control" name="content" placeholder="e.g., algorithmic solutions for real-world problems" required>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Condition</label>
                      <input type="text" class="form-control" id="condition" placeholder="auto (optional)" readonly>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Criterion</label>
                      <input type="text" class="form-control" id="criterion" placeholder="auto (optional)" readonly>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Assessment -->
            <div class="col-12">
              <div class="card">
                <div class="card-header d-flex align-items-center">
                  <span class="icon-badge"><i class="bi bi-clipboard-check"></i></span>
                  <div>Assessment</div>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Assessment Suggestion (auto)</label>
                      <input type="text" class="form-control" id="assessment" name="assessment" placeholder="auto" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Evidence of Assessment (auto)</label>
                      <input type="text" class="form-control" id="evidence" name="evidence" placeholder="auto" readonly>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Delivery / Coursework -->
            <div class="col-12">
              <div class="card">
                <div class="card-header d-flex align-items-center">
                  <span class="icon-badge"><i class="bi bi-truck"></i></span>
                  <div>Delivery & Weighting</div>
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Delivery Mode</label>
                      <input type="text" class="form-control" name="delivery" placeholder="Lecture / Lab / Project">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Coursework Assessment Percentage (%)</label>
                      <input type="number" class="form-control" name="cw" min="0" max="100" step="1">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="col-12">
              <div class="sticky-actions d-flex justify-content-between align-items-center">
                <div class="muted"><i class="bi bi-info-circle me-1"></i>Complete required fields, then Generate.</div>
                <div class="d-flex gap-2">
                  <a href="{{ url_for('reset_table') }}" class="btn btn-outline-danger"><i class="bi bi-trash"></i> Reset History</a>
                  <a href="{{ url_for('download') }}" class="btn btn-outline-secondary"><i class="bi bi-download"></i> Download Table</a>
                  <button type="submit" class="btn btn-primary"><i class="bi bi-rocket-takeoff"></i> Generate</button>
                </div>
              </div>
            </div>

          </div>
        </form>
      </div>

      <!-- History (lazy shown) -->
      <div class="tab-pane fade" id="hist" role="tabpanel" aria-labelledby="hist-tab">
        <div class="card mt-3">
          <div class="card-header d-flex align-items-center">
            <span class="icon-badge"><i class="bi bi-clock-history"></i></span>
            <div>Generated CLO History</div>
          </div>
          <div class="card-body">
            <div id="historyPlaceholder" class="text-center text-muted">
              <i class="bi bi-eye"></i> History will appear here.
              <div class="mt-2">
                <button id="loadHistoryBtn" class="btn btn-outline-primary btn-sm"><i class="bi bi-eye"></i> Show History</button>
              </div>
            </div>
            <div id="historyArea" class="table-wrap" style="display:none;">
              <!-- Injected on demand -->
              <div id="historyHTML" class="mt-2"></div>
            </div>
            <!-- Keep server-rendered table HTML in a template tag (not visible at load) -->
            <template id="serverTable">
              {{ table_html|safe }}
            </template>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Discipline/profile switch → reload with query param
    const profileSel = document.getElementById('profile');
    if (profileSel) {
      profileSel.addEventListener('change', () => {
        const val = profileSel.value || '';
        const url = new URL(window.location.href);
        if (val) url.searchParams.set('profile', val); else url.searchParams.delete('profile');
        window.location.href = url.toString();
      });
    }

    // History tab: inject table only when user clicks
    const histTab = document.getElementById('hist-tab');
    const loadBtn = document.getElementById('loadHistoryBtn');
    const placeholder = document.getElementById('historyPlaceholder');
    const historyArea = document.getElementById('historyArea');
    const historyHTML = document.getElementById('historyHTML');
    const serverTable = document.getElementById('serverTable');

    function showHistory() {
      if (serverTable && serverTable.innerHTML.trim() !== '') {
        historyHTML.innerHTML = serverTable.innerHTML;
        placeholder.style.display = 'none';
        historyArea.style.display = 'block';
      }
    }

    if (histTab) {
      histTab.addEventListener('shown.bs.tab', showHistory);
    }
    if (loadBtn) {
      loadBtn.addEventListener('click', showHistory);
    }

    // Dynamic PLO → Blooms → Verbs
    const ploSel = document.getElementById('plo');
    const bloomSel = document.getElementById('bloom');
    const verbSel = document.getElementById('verb');
    const scCode = document.getElementById('sc_code');
    const scDesc = document.getElementById('sc_desc');
    const vbe = document.getElementById('vbe');
    const domain = document.getElementById('domain');
    const condition = document.getElementById('condition');
    const criterion = document.getElementById('criterion');
    const assess = document.getElementById('assessment');
    const evid = document.getElementById('evidence');
    const verbSpinner = document.getElementById('verbSpinner');

    async function fetchJSON(url) {
      const r = await fetch(url);
      if (!r.ok) return null;
      return await r.json();
    }

    async function refreshPLODetails(p) {
      const info = await fetchJSON(`/api/debug_plo/${encodeURIComponent(p)}`);
      if (info && info.exists && info.details) {
        scCode.value = info.details.SC_Code || '';
        scDesc.value = info.details.SC_Desc || '';
        vbe.value = info.details.VBE || '';
        domain.value = info.details.Domain || '';
      } else {
        scCode.value = scDesc.value = vbe.value = domain.value = '';
      }
    }

    async function refreshBlooms(p) {
      bloomSel.innerHTML = `<option value="" selected disabled>Choose Bloom…</option>`;
      const blooms = await fetchJSON(`/api/get_blooms/${encodeURIComponent(p)}`) || [];
      blooms.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b; opt.textContent = b;
        bloomSel.appendChild(opt);
      });
      // Clear verbs list
      verbSel.innerHTML = `<option value="" selected disabled>Choose Verb…</option>`;
    }

    async function refreshVerbs(p, b) {
      verbSel.innerHTML = `<option value="" selected disabled>Choose Verb…</option>`;
      verbSpinner.style.display = 'block';
      const verbs = await fetchJSON(`/api/get_verbs/${encodeURIComponent(p)}/${encodeURIComponent(b)}`) || [];
      verbs.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v;
        verbSel.appendChild(opt);
      });
      verbSpinner.style.display = 'none';
      // Also pull condition/criterion/assessment via server on submit,
      // but we can optionally prefill here if you add an API.
    }

    ploSel?.addEventListener('change', async (e) => {
      const p = e.target.value;
      await refreshPLODetails(p);
      await refreshBlooms(p);
    });

    bloomSel?.addEventListener('change', async (e) => {
      const b = e.target.value;
      const p = ploSel.value;
      if (p && b) {
        await refreshVerbs(p, b);
        // Clear dependent auto fields on change
        assess.value = ''; evid.value = ''; condition.value = ''; criterion.value = '';
      }
    });
  </script>
</body>
</html>
