<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CLO Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    body{background:#f5f4fb;font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .navbar-custom{background:#5a2ca0}
    .navbar-custom .navbar-brand,.navbar-custom .nav-link,.navbar-custom label{color:#fff}
    .brand-title{font-weight:700;letter-spacing:.5px}
    .dev-credit{background:#ede6ff;color:#3b2f5b}
    .card{border:0;border-radius:1rem;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    .card-header{background:#fff;border-bottom:0;font-weight:600;font-size:1.05rem;display:flex;align-items:center;gap:.6rem;color:#3b2f5b}
    .icon-badge{width:40px;height:40px;border-radius:10px;background:#ede6ff;color:#5a2ca0;display:inline-flex;justify-content:center;align-items:center;font-size:18px}
    .btn-primary{background:#5a2ca0!important;border-color:#5a2ca0!important}
    .nav-pills .nav-link.active{background-color:#5a2ca0}
    .nav-pills .nav-link{color:#3b2f5b}
    .sticky-actions{position:sticky;bottom:0;background:#fff;padding:1rem;border-radius:1rem;box-shadow:0 -6px 18px rgba(0,0,0,.06);margin-top:1rem}
    .table-container{overflow-x:auto}
  </style>
</head>
<body>

  <!-- Top Navbar -->
  <nav class="navbar navbar-custom navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand brand-title" href="#">
        <i class="bi bi-magic me-2"></i>CLO Generator
      </a>

      <!-- Discipline dropdown -->
      <div class="d-flex align-items-center ms-auto">
        <form id="profileForm" class="d-flex align-items-center text-white">
          <label class="me-2">Discipline:</label>
          <select id="profile" class="form-select form-select-sm">
            <option value="">Medical &amp; Health Sciences</option>
            <option value="sc">Computer Science &amp; IT</option>
            <option value="eng">Engineering &amp; Technology</option>
            <option value="socs">Social Sciences</option>
            <option value="edu">Education</option>
            <option value="bus">Business &amp; Management</option>
            <option value="arts">Arts &amp; Humanities</option>
          </select>
        </form>
      </div>
    </div>
  </nav>

  <!-- Developer credit -->
  <div class="dev-credit py-2">
    <div class="container small">
      <i class="bi bi-person-badge me-1"></i>
      This app was developed by <strong>Assoc Prof Dr Hazwani Ahmad Yuso@Hanafi</strong> (AMDI USM).
    </div>
  </div>

  <main class="container my-4">

    <!-- Tabs -->
    <ul class="nav nav-pills mb-3" id="cloTabs">
      <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tabGenerate">
          <i class="bi bi-pencil-square me-1"></i>Generate CLO
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tabHistory">
          <i class="bi bi-table me-1"></i>History
        </button>
      </li>
    </ul>

    <div class="tab-content">

      <!-- GENERATE TAB -->
      <div class="tab-pane fade show active" id="tabGenerate">

        <form method="POST" action="{{ url_for('generate') }}" id="cloForm">
          <!-- keep profile in form for POST fallback -->
          <input type="hidden" id="profileHidden" name="profile" value="{{ profile|default('') }}"/>

          <div class="row g-3">

            <!-- Course + Mapping -->
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <span class="icon-badge"><i class="bi bi-journal-text"></i></span>
                  Course &amp; Mapping
                </div>
                <div class="card-body">
                  <label class="form-label">Course Code / Name *</label>
                  <input name="course" class="form-control" required>

                  <label class="form-label mt-3">PLO *</label>
                  <select name="plo" id="plo" class="form-select" required>
                    <option value="" disabled selected>Select PLO</option>
                    {% for p in plos %}
                      <option value="{{ p }}">{{ p }}</option>
                    {% endfor %}
                  </select>

                  <div class="row mt-3">
                    <div class="col-md-4">
                      <label class="form-label">SC Code</label>
                      <input id="sc_code" class="form-control" readonly>
                    </div>
                    <div class="col-md-8">
                      <label class="form-label">SC Description</label>
                      <input id="sc_desc" class="form-control" readonly>
                    </div>
                  </div>

                  <div class="row mt-3">
                    <div class="col-md-6">
                      <label class="form-label">VBE</label>
                      <input id="vbe" class="form-control" readonly>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Domain</label>
                      <input id="domain" class="form-control" readonly>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bloom + Verb + Meta -->
            <div class="col-lg-6">
              <div class="card">
                <div class="card-header">
                  <span class="icon-badge"><i class="bi bi-bar-chart-steps"></i></span>
                  Domain · Bloom · Criterion · Condition
                </div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Bloom Level *</label>
                      <select id="bloom" name="bloom" class="form-select" required></select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Criterion (Auto-fill list)</label>
                      <select id="criterion" class="form-select">
                        <!-- populated by JS from static list; auto-selected by /api/get_meta when available -->
                      </select>
                    </div>
                    <div class="col-md-12">
                      <label class="form-label">Condition (Universal list)</label>
                      <select id="condition" class="form-select">
                        <!-- populated by JS from static list; auto-selected by /api/get_meta when available -->
                      </select>
                    </div>
                    <div class="col-md-12">
                      <label class="form-label">Verb *</label>
                      <select id="verb" name="verb" class="form-select" required></select>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- CLO Builder -->
            <div class="col-12">
              <div class="card">
                <div class="card-header">
                  <span class="icon-badge"><i class="bi bi-pencil"></i></span>
                  CLO Builder
                </div>
                <div class="card-body">
                  <label class="form-label">Content / Object *</label>
                  <input name="content" class="form-control" required>

                  <div class="row mt-3">
                    <div class="col-md-4">
                      <label class="form-label">Assessment %</label>
                      <input type="number" min="0" max="100" step="1" name="cw" class="form-control">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Assessment Suggestion</label>
                      <input name="assessment" id="assessment" class="form-control" readonly>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Evidence of Assessment</label>
                      <input name="evidence" id="evidence" class="form-control" readonly>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="col-12">
              <div class="sticky-actions d-flex justify-content-between">
                <div class="text-muted">
                  <i class="bi bi-info-circle"></i> Complete required fields then click Generate.
                </div>
                <div class="d-flex gap-2">
                  <a href="{{ url_for('reset_table') }}" class="btn btn-outline-danger">
                    <i class="bi bi-trash"></i> Reset History
                  </a>
                  <a href="{{ url_for('download') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-download"></i> Download
                  </a>
                  <button class="btn btn-primary">
                    <i class="bi bi-rocket-takeoff"></i> Generate
                  </button>
                </div>
              </div>
            </div>

          </div>
        </form>

        <!-- Preview -->
        <div class="card mt-4" id="cloPreviewCard" style="display:none;">
          <div class="card-header">
            <span class="icon-badge"><i class="bi bi-lightbulb"></i></span>
            Generated CLO
          </div>
          <div class="card-body">
            <p id="cloPreviewText" style="font-size:1.05rem;color:#3b2f5b;font-weight:500;"></p>
          </div>
        </div>
      </div>

      <!-- HISTORY TAB -->
      <div class="tab-pane fade" id="tabHistory">
        <div class="card mt-3">
          <div class="card-header">
            <span class="icon-badge"><i class="bi bi-clock-history"></i></span>
            CLO History
          </div>
          <div class="card-body">
            <div id="historyPlaceholder" class="text-muted text-center">
              <i class="bi bi-eye"></i> Click to load history.
              <div class="mt-2">
                <button id="loadHistoryBtn" class="btn btn-outline-primary btn-sm">Show History</button>
              </div>
            </div>

            <div id="historyArea" class="table-container" style="display:none;">
              <div id="historyHTML"></div>
            </div>

            <template id="serverTable">
              {{ table_html|safe }}
            </template>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ---------- Profile handling ----------
    const profileSel = document.getElementById("profile");
    profileSel.value = "{{ profile|default('') }}";
    profileSel.addEventListener("change", () => {
      const val = profileSel.value;
      const url = new URL(window.location.href);
      if (val) url.searchParams.set("profile", val);
      else url.searchParams.delete("profile");
      window.location.href = url.toString();
    });
    function profileSuffix() {
      const p = profileSel.value || "{{ profile|default('') }}";
      return p ? `?profile=${encodeURIComponent(p)}` : "";
    }

    // ---------- Static lists ----------
    const CRITERIA_LIST = [
      "accurately","appropriately","safely","independently","efficiently",
      "comprehensively","critically","ethically","consistently","effectively"
    ];

    const UNIVERSAL_CONDITIONS = [
      "when recalling theoretical concepts",
      "when explaining physiological mechanisms",
      "in clinical or exercise scenarios",
      "when interpreting data or case studies",
      "during problem-solving or reflection",
      "when designing exercise programs or interventions",
      "during discussions or peer activities",
      "when engaging in teamwork or feedback",
      "in ethical or professional contexts",
      "when integrating multiple perspectives",
      "throughout clinical or professional practice",
      "during demonstration or observation",
      "before performing a skill",
      "during skill acquisition or practice",
      "in executing learned motor tasks",
      "during continuous performance",
      "when adjusting to new conditions",
      "when developing new movement patterns"
    ];

    // Populate static dropdowns once
    const criterionSel = document.getElementById("criterion");
    const conditionSel = document.getElementById("condition");
    function fillStaticLists() {
      criterionSel.innerHTML = "";
      CRITERIA_LIST.forEach(c => {
        const o = document.createElement("option"); o.value = o.textContent = c; criterionSel.appendChild(o);
      });
      conditionSel.innerHTML = "";
      UNIVERSAL_CONDITIONS.forEach(c => {
        const o = document.createElement("option"); o.value = o.textContent = c; conditionSel.appendChild(o);
      });
    }
    fillStaticLists();

    // ---------- Helpers ----------
    async function fetchJSON(url) {
      const r = await fetch(url);
      if (!r.ok) return null;
      return await r.json();
    }

    // ---------- Elements ----------
    const ploSel   = document.getElementById("plo");
    const bloomSel = document.getElementById("bloom");
    const verbSel  = document.getElementById("verb");
    const scCode   = document.getElementById("sc_code");
    const scDesc   = document.getElementById("sc_desc");
    const vbe      = document.getElementById("vbe");
    const domain   = document.getElementById("domain");
    const assessEl = document.getElementById("assessment");
    const evidEl   = document.getElementById("evidence");
    const profileHidden = document.getElementById("profileHidden");

    // ---------- PLO -> details + blooms ----------
    async function refreshPLO(plo) {
      const info = await fetchJSON(`/api/debug_plo/${encodeURIComponent(plo)}${profileSuffix()}`);
      if (info && info.exists) {
        scCode.value = info.details.SC_Code || "";
        scDesc.value = info.details.SC_Desc || "";
        vbe.value    = info.details.VBE || "";
        domain.value = info.details.Domain || "";
      } else {
        scCode.value = scDesc.value = vbe.value = domain.value = "";
      }
    }
    async function refreshBlooms(plo) {
      bloomSel.innerHTML = '<option disabled selected>Select Bloom</option>';
      verbSel.innerHTML  = '<option disabled selected>Select Verb</option>';
      const blooms = await fetchJSON(`/api/get_blooms/${encodeURIComponent(plo)}${profileSuffix()}`) || [];
      blooms.forEach(b => {
        const o = document.createElement("option");
        o.value = o.textContent = b;
        bloomSel.appendChild(o);
      });
    }

    // ---------- Bloom -> verbs + meta ----------
    async function refreshVerbs(plo, bloom) {
      verbSel.innerHTML = '<option disabled selected>Select Verb</option>';
      const verbs = await fetchJSON(`/api/get_verbs/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}${profileSuffix()}`) || [];
      verbs.forEach(v => {
        const o = document.createElement("option");
        o.value = o.textContent = v;
        verbSel.appendChild(o);
      });
    }
    async function refreshMeta(plo, bloom) {
      const m = await fetchJSON(`/api/get_meta/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}${profileSuffix()}`);
      if (!m) return;
      // Try to auto-select matching options if present
      if (m.criterion) {
        const idx = CRITERIA_LIST.findIndex(x => x.toLowerCase() === m.criterion.toLowerCase());
        criterionSel.selectedIndex = idx >= 0 ? idx : 0;
      }
      if (m.condition) {
        const idx2 = UNIVERSAL_CONDITIONS.findIndex(x => x.toLowerCase() === m.condition.toLowerCase());
        conditionSel.selectedIndex = idx2 >= 0 ? idx2 : 0;
      }
      assessEl.value = m.assessment || "";
      evidEl.value   = m.evidence || "";
    }

    // ---------- Events ----------
    ploSel.addEventListener("change", async () => {
      const p = ploSel.value;
      profileHidden.value = profileSel.value || "{{ profile|default('') }}";
      await refreshPLO(p);
      await refreshBlooms(p);
      // clear dependent
      bloomSel.value = ""; verbSel.value = "";
      assessEl.value = evidEl.value = "";
    });

    bloomSel.addEventListener("change", async () => {
      const b = bloomSel.value;
      const p = ploSel.value;
      if (!p || !b) return;
      await refreshVerbs(p, b);
      await refreshMeta(p, b);
    });

    // ---------- AJAX submit: generate + preview ----------
    document.getElementById("cloForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      profileHidden.value = profileSel.value || "{{ profile|default('') }}";

      // send chosen criterion/condition along with form (add to FormData)
      const fd = new FormData(e.target);
      fd.set("criterion", criterionSel.value);
      fd.set("condition", conditionSel.value);

      const res = await fetch(`/generate${profileSuffix()}`, { method: "POST", body: fd });
      const data = await res.json();
      if (data.error) { alert(data.error); return; }

      document.getElementById("cloPreviewCard").style.display = "block";
      document.getElementById("cloPreviewText").innerText = data.clo;

      // make sure these are set even if backend recomputed
      assessEl.value = data.assessment || assessEl.value;
      evidEl.value   = data.evidence   || evidEl.value;
    });

    // ---------- History loader ----------
    const loadBtn = document.getElementById("loadHistoryBtn");
    const serverTable = document.getElementById("serverTable");
    const historyArea = document.getElementById("historyArea");
    const historyPlaceholder = document.getElementById("historyPlaceholder");
    const historyHTML = document.getElementById("historyHTML");
    function loadHistory() {
      historyHTML.innerHTML = serverTable.innerHTML;
      historyPlaceholder.style.display = "none";
      historyArea.style.display = "block";
    }
    loadBtn?.addEventListener("click", loadHistory);
    document.querySelector('[data-bs-target="#tabHistory"]')?.addEventListener("shown.bs.tab", loadHistory);
  </script>
</body>
</html>
