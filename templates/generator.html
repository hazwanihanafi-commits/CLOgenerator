<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SCLOG — Smart Course Learning Outcome Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap + icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --muted:#6b7280; --accent:#1766d8;
      --glass: rgba(255,255,255,0.7);
    }
    [data-theme="dark"]{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#3aa0ff; --glass: rgba(10,14,20,0.6);
      color: #e6eefc;
    }
    body { background:var(--bg); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .app-shell { display:flex; min-height:100vh; gap:20px; padding:20px; }
    .sidebar { width:300px; flex-shrink:0; }
    .card-box { background:var(--card); border-radius:12px; padding:16px; box-shadow:0 8px 24px rgba(16,24,40,0.06); }
    .app-main { flex:1; }
    .brand { font-weight:700; color:var(--accent); display:flex; gap:10px; align-items:center; }
    .small-muted { color:var(--muted); font-size:.92rem; }
    .variant-item { padding:10px; border-radius:8px; border:1px solid rgba(16,24,40,0.04); margin-bottom:8px; cursor:pointer; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent); }
    .loader { display:inline-block; width:16px; height:16px; border:2px solid rgba(0,0,0,0.08); border-top-color:var(--accent); border-radius:50%; animation:spin 0.9s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg);} }
    /* responsive */
    @media (max-width: 991px){
      .app-shell { flex-direction:column; padding:12px; }
      .sidebar { width:100%; order:2; }
      .app-main { order:1; }
    }
    /* tab content scroll */
    .tab-pane { max-height:70vh; overflow:auto; padding-top:8px; }
    .field-chip { display:inline-block; padding:6px 10px; border-radius:999px; background:rgba(23,102,216,0.08); color:var(--accent); margin-right:6px; font-size:.85rem; }
    .muted-pill { background: rgba(16,24,40,0.03); padding:6px 8px; border-radius:6px; font-size:.85rem; color:var(--muted); }
  </style>
</head>
<body data-theme="light">
  <div class="app-shell container-fluid">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="card-box mb-3">
        <div class="brand mb-2"><i class="bi bi-stars" style="font-size:1.4rem;"></i> SCLOG — Smart CLO Generator</div>
        <div class="small-muted mb-2">Smart CLO authoring — upgraded UI</div>

        <label class="form-label mt-2 small-muted">Profile</label>
        <select id="profile" class="form-select mb-2">
          <option value="health">Medical & Health</option>
          <option value="sc" selected>Computer Science & IT</option>
          <option value="eng">Engineering & Technology</option>
          <option value="socs">Social Sciences</option>
          <option value="edu">Education</option>
          <option value="bus">Business & Management</option>
          <option value="arts">Arts & Humanities</option>
        </select>

        <label class="form-label mt-2 small-muted">Level</label>
        <select id="level" class="form-select mb-2">
          <option>Diploma</option>
          <option>Degree</option>
          <option>Master</option>
          <option>PhD</option>
        </select>

        <hr>

        <label class="form-label small-muted">Field (content suggestions)</label>
        <select id="field" class="form-select mb-2">
          <option value="">— Select Field —</option>
          <option>Computer Science</option>
          <option>Medical & Health</option>
          <option>Engineering</option>
          <option>Social Sciences</option>
          <option>Education</option>
          <option>Business</option>
          <option>Arts & Humanities</option>
        </select>

        <div class="d-flex gap-2 mt-2">
          <button id="darkToggle" class="btn btn-outline-secondary btn-sm w-100"><i class="bi bi-moon"></i> Dark</button>
        </div>

        <hr>

        <div class="small-muted">Quick actions</div>
        <div class="d-grid gap-2 mt-2">
          <button id="downloadBtn" class="btn btn-success btn-sm"><i class="bi bi-download me-1"></i> Download CLO</button>
          <button id="downloadRubricBtn" class="btn btn-outline-secondary btn-sm"><i class="bi bi-file-earmark-text me-1"></i> Download Rubric</button>
        </div>
      </div>

      <div class="card-box">
        <div class="small-muted mb-2">IEG → PEO → PLO mapping</div>
        <label class="form-label small-muted">IEG</label>
        <select id="ieg" class="form-select mb-2"><option value="">Select IEG</option></select>

        <label class="form-label small-muted">PEO</label>
        <select id="peo" class="form-select mb-2"><option value="">Select PEO</option></select>

        <label class="form-label small-muted">PLO</label>
        <select id="plo" class="form-select mb-2"><option value="">Select PLO</option></select>

        <div class="mt-2 small-muted">Statements</div>
        <div class="mt-2">
          <div><strong>PEO:</strong> <span id="peo_statement" class="small-muted">—</span></div>
          <div><strong>PLO:</strong> <span id="plo_statement" class="small-muted">—</span></div>
          <div><strong>Indicator:</strong> <span id="plo_indicator" class="small-muted">—</span></div>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="app-main">
      <div class="card-box mb-3">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h4 class="mb-0">Smart CLO Builder</h4>
            <div class="small-muted">Create measurable course learning outcomes quickly</div>
          </div>
          <div class="small-muted text-end">Made for 2025 • Responsive • Dark mode</div>
        </div>
      </div>

      <div class="card-box mb-3">
        <ul class="nav nav-tabs" id="tabNav" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="builder-tab" data-bs-toggle="tab" data-bs-target="#builder" type="button">Builder</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="variants-tab" data-bs-toggle="tab" data-bs-target="#variants" type="button">Variants</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="assessment-tab" data-bs-toggle="tab" data-bs-target="#assessment" type="button">Assessment</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">History</button>
          </li>
        </ul>

        <div class="tab-content mt-3">
          <!-- BUILDER -->
          <div class="tab-pane fade show active" id="builder">
            <div class="row g-3">
              <div class="col-lg-8">
                <div class="mb-2">
                  <label class="form-label small-muted">Bloom</label>
                  <select id="bloom" class="form-select"><option value="">Select Bloom</option></select>
                </div>
                <div class="mb-2">
                  <label class="form-label small-muted">Verb</label>
                  <select id="verb" class="form-select"><option value="">Select Verb</option></select>
                </div>
                <div class="mb-2">
                  <label class="form-label small-muted">Content (topic / object)</label>
                  <input id="content" class="form-control" placeholder="e.g., interpret ECG waveforms">
                </div>

                <div class="mt-2 d-flex gap-2">
                  <button id="generateBtn" class="btn btn-primary"><i class="bi bi-magic me-1"></i> Generate CLO</button>
                  <button id="copyBtn" class="btn btn-outline-secondary"><i class="bi bi-clipboard"></i> Copy</button>
                  <div id="busy" style="display:none;" class="align-self-center"><span class="loader"></span> Generating...</div>
                </div>

                <div id="cloCard" class="mt-3 card-box" style="display:none;">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="mb-1">Generated CLO</h6>
                      <div id="clo_text" class="fw-semibold"></div>
                    </div>
                    <div class="text-end small-muted">
                      <div id="meta_small">—</div>
                    </div>
                  </div>

                  <div class="mt-3">
                    <button id="toggleVariants" class="btn btn-sm btn-outline-primary">Show variants</button>
                    <div id="variantsPanel" style="display:none; margin-top:10px;"></div>
                  </div>
                </div>
              </div>

              <div class="col-lg-4">
                <div class="card-box">
                  <div class="small-muted mb-2">Mapping metadata</div>
                  <div class="mb-2"><strong>SC Code</strong><div id="sc_code" class="small-muted">—</div></div>
                  <div class="mb-2"><strong>SC Description</strong><div id="sc_desc" class="small-muted">—</div></div>
                  <div class="mb-2"><strong>VBE</strong><div id="vbe" class="small-muted">—</div></div>
                  <div class="mb-2"><strong>Domain</strong><div id="domain" class="small-muted">—</div></div>
                  <div class="mb-2"><strong>Condition</strong><div id="condition" class="small-muted">—</div></div>
                  <div class="mb-2"><strong>Criterion</strong><div id="criterion" class="small-muted">—</div></div>
                </div>

                <div class="card-box mt-3">
                  <div class="small-muted mb-1">Quick content suggestions</div>
                  <div id="content_suggestions"></div>
                </div>

              </div>
            </div>
          </div>

          <!-- VARIANTS -->
          <div class="tab-pane fade" id="variants">
            <div id="variants_list" class="tab-pane-content"></div>
          </div>

          <!-- ASSESSMENT -->
          <div class="tab-pane fade" id="assessment">
            <div class="row">
              <div class="col-lg-6">
                <div class="card-box">
                  <h6>Assessment methods</h6>
                  <div id="assess_list" class="small-muted">—</div>
                </div>
              </div>
              <div class="col-lg-6">
                <div class="card-box">
                  <h6>Suggested evidence</h6>
                  <div id="evidence_list" class="small-muted">—</div>
                </div>
              </div>
            </div>
          </div>

          <!-- HISTORY -->
          <div class="tab-pane fade" id="history">
            <div class="card-box">
              <h6>Recent generation</h6>
              <div id="history_list" class="small-muted">No history in this demo (server-side saved CLO available for download).</div>
            </div>
          </div>

        </div>
      </div>
    </main>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* -------------------------
   Helpers & element refs
--------------------------*/
const $ = id => document.getElementById(id);
const profileSel = $('profile');
const levelSel = $('level');
const fieldSel = $('field');
const iegSel = $('ieg');
const peoSel = $('peo');
const ploSel = $('plo');

const bloomSel = $('bloom');
const verbSel = $('verb');
const contentInput = $('content');

const scCodeEl = $('sc_code');
const scDescEl = $('sc_desc');
const vbeEl = $('vbe');
const domainEl = $('domain');
const conditionEl = $('condition');
const criterionEl = $('criterion');

const cloCard = $('cloCard');
const cloText = $('clo_text');
const variantsPanel = $('variantsPanel');
const variantsList = $('variants_list');
const assessList = $('assess_list');
const evidenceList = $('evidence_list');
const contentSuggestionsEl = $('content_suggestions');

const busyEl = $('busy');
const downloadBtn = $('downloadBtn');
const downloadRubricBtn = $('downloadRubricBtn');
const darkToggle = $('darkToggle');
const toggleVariantsBtn = $('toggleVariants');
const copyBtn = $('copyBtn');
const generateBtn = $('generateBtn');

let LAST_CLO = null;

/* -------------------------
   Dark mode toggle
--------------------------*/
darkToggle.addEventListener('click', () => {
  const root = document.documentElement;
  const curr = document.body.getAttribute('data-theme') || 'light';
  const next = curr === 'light' ? 'dark' : 'light';
  document.body.setAttribute('data-theme', next);
  darkToggle.innerHTML = next === 'dark' ? '<i class="bi bi-sun"></i> Light' : '<i class="bi bi-moon"></i> Dark';
});

/* -------------------------
   Load mapping JSON
--------------------------*/
async function loadMapping(){
  try {
    const res = await fetch('/api/mapping');
    const map = await res.json();
    window.MAP = map;
    // populate IEGs
    iegSel.innerHTML = '<option value="">Select IEG</option>';
    (map.IEGs||[]).forEach(i => iegSel.add(new Option(i,i)));
    // pre-populate PLO list (fallback)
    ploSel.innerHTML = '<option value="">Select PLO</option>';
    (map.PLOs||[]).forEach(p => ploSel.add(new Option(p,p)));
  } catch(err){
    console.warn('mapping load', err);
  }
}

/* -------------------------
   IEG -> PEO cascading
--------------------------*/
iegSel.addEventListener('change', async () => {
  const ieg = iegSel.value;
  peoSel.innerHTML = '<option value="">Loading…</option>';
  ploSel.innerHTML = '<option value="">Select PLO</option>';
  if (!ieg) { peoSel.innerHTML = '<option value="">Select PEO</option>'; return; }

  try {
    const res = await fetch(`/api/get_peos/${encodeURIComponent(ieg)}`);
    const peos = await res.json();
    peoSel.innerHTML = '<option value="">Select PEO</option>';
    (peos||[]).forEach(p => peoSel.add(new Option(p,p)));
  } catch(e){ console.error(e); peoSel.innerHTML = '<option value="">Error</option>'; }
});

/* -------------------------
   PEO -> PLO cascading
--------------------------*/
peoSel.addEventListener('change', async () => {
  const peo = peoSel.value;
  ploSel.innerHTML = '<option value="">Loading…</option>';
  if (!peo) { ploSel.innerHTML = '<option value="">Select PLO</option>'; return; }
  try {
    const res = await fetch(`/api/get_plos/${encodeURIComponent(peo)}`);
    const plos = await res.json();
    ploSel.innerHTML = '<option value="">Select PLO</option>';
    (plos||[]).forEach(p => ploSel.add(new Option(p,p)));
    // load PEO statement
    const level = levelSel.value || 'Degree';
    try {
      const stmtRes = await fetch(`/api/get_statement/${encodeURIComponent(level)}/PEO/${encodeURIComponent(peo)}`);
      const stmt = await stmtRes.json();
      $('peo_statement').textContent = stmt || '—';
    } catch(e){ $('peo_statement').textContent = '—'; }
  } catch(e){ console.error(e); ploSel.innerHTML = '<option value="">Error</option>'; }
});

/* -------------------------
   PLO -> Bloom + statements
--------------------------*/
ploSel.addEventListener('change', async () => {
  const plo = ploSel.value;
  bloomSel.innerHTML = '<option>Loading…</option>';
  if (!plo) { bloomSel.innerHTML = '<option value="">Select Bloom</option>'; return; }
  // Blooms
  try {
    const res = await fetch(`/api/get_blooms/${encodeURIComponent(plo)}?profile=${encodeURIComponent(profileSel.value)}`);
    const blooms = await res.json();
    bloomSel.innerHTML = '<option value="">Select Bloom</option>';
    (blooms||[]).forEach(b => bloomSel.add(new Option(b,b)));
  } catch(e){ bloomSel.innerHTML = '<option value="">Error</option>'; }

  // PLO statement + indicator
  const lvl = levelSel.value || 'Degree';
  try {
    const stmtRes = await fetch(`/api/get_statement/${encodeURIComponent(lvl)}/PLO/${encodeURIComponent(plo)}`);
    const stmt = await stmtRes.json();
    $('plo_statement').textContent = stmt || '—';
  } catch(e){ $('plo_statement').textContent = '—'; }

  try {
    const map = window.MAP || {};
    $('plo_indicator').textContent = (map.PLOIndicators && map.PLOIndicators[plo]) || '—';
  } catch(e){ $('plo_indicator').textContent = '—'; }
});

/* -------------------------
   Bloom -> verbs + meta
--------------------------*/
bloomSel.addEventListener('change', async () => {
  const bloom = bloomSel.value;
  const plo = ploSel.value;
  // verbs
  if (!bloom || !plo) return;
  try {
    const vres = await fetch(`/api/get_verbs/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}?profile=${encodeURIComponent(profileSel.value)}`);
    const verbs = await vres.json();
    verbSel.innerHTML = '<option value="">Select Verb</option>';
    (verbs||[]).forEach(v => verbSel.add(new Option(v,v)));
  } catch(e){ console.error(e); verbSel.innerHTML = '<option value="">Error</option>'; }

  // meta
  try {
    const mres = await fetch(`/api/get_meta/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}?profile=${encodeURIComponent(profileSel.value)}`);
    const meta = await mres.json();
    scCodeEl.textContent = meta.sc_code || '—';
    scDescEl.textContent = meta.sc_desc || '—';
    vbeEl.textContent = meta.vbe || '—';
    domainEl.textContent = meta.domain || '—';
    conditionEl.textContent = meta.condition || '—';
    criterionEl.textContent = meta.criterion || '—';
  } catch(e){ console.error(e); }
});

/* -------------------------
   Field -> content suggestions
--------------------------*/
fieldSel.addEventListener('change', async () => {
  const field = fieldSel.value;
  contentSuggestionsEl.innerHTML = '';
  if (!field) return;
  try {
    const res = await fetch(`/api/content/${encodeURIComponent(field)}`);
    const list = await res.json();
    contentSuggestionsEl.innerHTML = '';
    (list||[]).forEach(s => {
      const btn = document.createElement('button');
      btn.className = 'btn btn-sm btn-light me-1 mb-1';
      btn.textContent = s;
      btn.onclick = () => { contentInput.value = s; };
      contentSuggestionsEl.appendChild(btn);
    });
  } catch(e){ console.error(e); }
});

/* -------------------------
   Generate CLO
--------------------------*/
generateBtn.addEventListener('click', async () => {
  if (!ploSel.value || !bloomSel.value || !verbSel.value || !contentInput.value.trim()){
    alert('Please fill PLO, Bloom, Verb and Content.');
    return;
  }
  busyEl.style.display = 'inline-block';
  generateBtn.disabled = true;

  const fd = new FormData();
  fd.append('profile', profileSel.value);
  fd.append('level', levelSel.value);
  fd.append('plo', ploSel.value);
  fd.append('bloom', bloomSel.value);
  fd.append('verb', verbSel.value);
  fd.append('content', contentInput.value);

  try {
    const res = await fetch('/generate', { method:'POST', body: fd});
    if (!res.ok) {
      const err = await res.json().catch(()=>({error:'Server error'}));
      throw new Error(err.error || 'Failed to generate');
    }
    const data = await res.json();
    LAST_CLO = data;
    // show CLO
    cloText.innerText = data.clo || '';
    cloCard.style.display = 'block';
    // show variants
    variantsPanel.innerHTML = '';
    const opts = data.clo_options || {};
    for (const [label, text] of Object.entries(opts)) {
      const div = document.createElement('div');
      div.className = 'variant-item';
      div.innerHTML = `<strong>${label}</strong><div class="mt-1">${text}</div>`;
      div.onclick = () => { cloText.innerText = text; };
      variantsPanel.appendChild(div);
    }
    // assessment
    const assessments = data.assessments || [];
    assessList.innerHTML = assessments.length ? ('<ul>' + assessments.map(a => `<li>${a}</li>`).join('') + '</ul>') : '—';
    // evidence
    const evidence = data.evidence || {};
    evidenceList.innerHTML = Object.keys(evidence).length ? Object.entries(evidence).map(([k,v]) => `<div><strong>${k}</strong>: ${v.join('; ')}</div>`).join('') : '—';
    // fill metadata fields in sidebar
    $('peo_statement').textContent = data.peo_statement || '—';
    $('plo_statement').textContent = data.plo_statement || '—';
    $('plo_indicator').textContent = data.plo_indicator || '—';
  } catch(err){
    console.error(err);
    alert('Error: ' + (err.message || 'Failed to generate'));
  } finally {
    busyEl.style.display = 'none';
    generateBtn.disabled = false;
  }
});

/* -------------------------
   Toggle variants panel
--------------------------*/
toggleVariantsBtn.addEventListener('click', () => {
  const hidden = variantsPanel.style.display === 'none' || variantsPanel.style.display === '';
  variantsPanel.style.display = hidden ? 'block' : 'none';
  toggleVariantsBtn.innerText = hidden ? 'Hide variants' : 'Show variants';
});

/* -------------------------
   Copy generated CLO
--------------------------*/
copyBtn.addEventListener('click', async () => {
  if (!cloText.innerText) return;
  try {
    await navigator.clipboard.writeText(cloText.innerText);
    copyBtn.innerText = 'Copied';
    setTimeout(()=> copyBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copy', 1200);
  } catch(e){ alert('Copy failed'); }
});

/* -------------------------
   Download buttons
--------------------------*/
downloadBtn.addEventListener('click', () => {
  window.location = '/download';
});
downloadRubricBtn.addEventListener('click', () => {
  window.location = '/download_rubric';
});

/* -------------------------
   Quick: when page loads
--------------------------*/
(function init(){
  loadMapping();
})();
</script>
  <footer style="
  width:100%;
  background:#0b1220;
  color:#d9e2f3;
  text-align:center;
  padding:14px 8px;
  margin-top:30px;
  border-radius:10px;
  font-size:.9rem;
  letter-spacing:0.3px;
">
  © 2025 • Developed by <strong>Assoc Prof Dr Hazwani Ahmad Yusof @ Hanafi</strong>,
  Universiti Sains Malaysia (USM)
</footer>

</body>
</html>
