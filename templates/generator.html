<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SCLOG — Smart CLO Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap + icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background:#f4f7fb; }
    .card-elev { border-radius:12px; box-shadow:0 6px 18px rgba(23,102,216,0.06); background:#fff; }
    .muted-small { color:#6b7280; font-size:0.95rem; }
    .variant-item { background:#fff; border:1px solid #eef4ff; border-radius:8px; padding:10px; margin-bottom:8px; cursor:pointer; }
    .loader { display:inline-block; width:16px; height:16px; border:2px solid #e9f2ff; border-top-color:#1766d8; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .small-muted {font-size:0.9rem;color:#6c757d;}
    .btn-sm-wide { padding-left:14px;padding-right:14px; }
  </style>
</head>
<body class="p-3">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-3">
    <div class="container-fluid">
      <span class="navbar-brand fw-bold">SCLOG — Smart CLO Generator</span>
      <div class="d-flex gap-2">
        <select id="profile" class="form-select form-select-sm" style="width:170px;">
          <option value="sc">Computer Science</option>
          <option value="health">Medical & Health</option>
          <option value="eng">Engineering</option>
          <option value="socs">Social Sciences</option>
          <option value="edu">Education</option>
          <option value="bus">Business</option>
          <option value="arts">Arts & Humanities</option>
        </select>
      </div>
    </div>
  </nav>

  <main class="container">
    <div class="row g-4">

      <!-- Left column: mapping, statements, downloads -->
      <div class="col-lg-5">
        <div class="card card-elev p-3 mb-3">
          <h5 class="mb-3">Mapping — IEG → PEO → PLO</h5>

          <div class="mb-2">
            <label class="form-label">Level</label>
            <select id="level" class="form-select">
              <option>Degree</option>
              <option>Diploma</option>
              <option>Master</option>
              <option>PhD</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">IEG</label>
            <select id="ieg" class="form-select">
              <option value="">— Select IEG —</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">PEO</label>
            <select id="peo" class="form-select">
              <option value="">— Select PEO —</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">PLO</label>
            <select id="plo" class="form-select">
              <option value="">— Select PLO —</option>
            </select>
          </div>

          <div class="mt-3">
            <div class="small-muted">PLO Indicator</div>
            <div id="plo_indicator" class="fw-semibold">—</div>
          </div>

          <div class="mt-3">
            <div class="small-muted">PEO Statement</div>
            <div id="peo_statement" class="fw-semibold">—</div>
          </div>

          <div class="mt-3">
            <div class="small-muted">PLO Statement</div>
            <div id="plo_statement" class="fw-semibold">—</div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <a id="download_clo" class="btn btn-outline-success btn-sm btn-sm-wide" href="/download"><span class="bi"></span> Download CLO Table</a>
            <a id="download_rubric" class="btn btn-outline-secondary btn-sm btn-sm-wide" href="/download_rubric">Download Rubric</a>
          </div>
        </div>

        <div class="card card-elev p-3">
          <h6 class="mb-2">Mapping summary</h6>
          <div class="meta-grid">
            <div class="mb-2"><div class="small-muted">SC Code</div><div id="sc_code" class="fw-semibold">—</div></div>
            <div class="mb-2"><div class="small-muted">SC Description</div><div id="sc_desc" class="fw-semibold">—</div></div>
            <div class="mb-2"><div class="small-muted">VBE</div><div id="vbe" class="fw-semibold">—</div></div>
            <div class="mb-2"><div class="small-muted">Domain</div><div id="domain" class="fw-semibold">—</div></div>
          </div>
        </div>
      </div>

      <!-- Right column: builder, preview, variants, rubric -->
      <div class="col-lg-7">
        <div class="card card-elev p-3 mb-3">
          <h5 class="mb-3">Bloom & CLO Builder</h5>

          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Bloom</label>
              <select id="bloom" class="form-select">
                <option value="">— Select Bloom —</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Verb</label>
              <select id="verb" class="form-select">
                <option value="">— Select Verb —</option>
              </select>
            </div>

            <div class="col-12 mt-2">
              <label class="form-label">Content (topic / object)</label>
              <input id="content" class="form-control" placeholder="e.g., interpret ECG waveforms, design an intervention plan" />
            </div>

            <div class="col-md-6 mt-2">
              <label class="form-label">Condition</label>
              <input id="condition" class="form-control" readonly />
            </div>

            <div class="col-md-6 mt-2">
              <label class="form-label">Criterion</label>
              <input id="criterion" class="form-control" readonly />
            </div>

            <div class="col-12 mt-3 d-flex align-items-center gap-2">
              <button id="generateBtn" type="button" class="btn btn-primary"><i class="bi bi-magic me-1"></i> Generate CLO</button>
              <div id="busy" style="display:none;"><span class="loader"></span> Generating…</div>
            </div>

          </div>
        </div>

        <!-- Preview + Variants -->
        <div class="card card-elev p-3 mb-3" id="previewPanel" style="display:none;">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="mb-1">Generated CLO</h6>
              <div id="cloPreviewText" class="fw-semibold"></div>
            </div>
            <div class="text-end">
              <button id="copyCloBtn" class="btn btn-outline-secondary btn-sm"><i class="bi bi-clipboard"></i> Copy</button>
            </div>
          </div>

          <div class="mt-3 d-flex justify-content-between align-items-center">
            <div><small class="text-muted">Alternative variants</small></div>
            <button id="toggleVariants" class="btn btn-sm btn-outline-primary">Show variants</button>
          </div>

          <div id="variantsPanel" style="display:none; margin-top:10px;"></div>
        </div>

        <!-- Rubric -->
        <div class="card card-elev p-3" id="rubricPanel" style="display:none;">
          <h6 class="mb-2">Rubric</h6>
          <div class="table-responsive">
            <table class="table table-sm">
              <tr><th>Indicator</th><td id="r_indicator"></td></tr>
              <tr><th>Excellent</th><td id="r_excellent"></td></tr>
              <tr><th>Good</th><td id="r_good"></td></tr>
              <tr><th>Satisfactory</th><td id="r_satisfactory"></td></tr>
              <tr><th>Poor</th><td id="r_poor"></td></tr>
            </table>
          </div>
        </div>

      </div>
    </div>
  </main>

  <footer class="text-center small text-muted my-3">
    SCLOG Generator — Developed by Assoc. Prof. Dr. Hazwani Ahmad Yusof @ USM
  </footer>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // Helper
  const $ = id => document.getElementById(id);

  // Elements
  const profileSel = $('profile');
  const levelSel = $('level');
  const iegSel = $('ieg');
  const peoSel = $('peo');
  const ploSel = $('plo');
  const bloomSel = $('bloom');
  const verbSel = $('verb');
  const contentEl = $('content');

  const scCodeEl = $('sc_code');
  const scDescEl = $('sc_desc');
  const vbeEl = $('vbe');
  const domainEl = $('domain');
  const conditionEl = $('condition');
  const criterionEl = $('criterion');

  const peoStatementEl = $('peo_statement');
  const ploStatementEl = $('plo_statement');
  const ploIndicatorEl = $('plo_indicator');

  const generateBtn = $('generateBtn');
  const busyEl = $('busy');

  const previewPanel = $('previewPanel');
  const cloPreviewText = $('cloPreviewText');
  const copyCloBtn = $('copyCloBtn');
  const variantsPanel = $('variantsPanel');
  const toggleVariantsBtn = $('toggleVariants');

  const rubricPanel = $('rubricPanel');
  const r_indicator = $('r_indicator');
  const r_excellent = $('r_excellent');
  const r_good = $('r_good');
  const r_satisfactory = $('r_satisfactory');
  const r_poor = $('r_poor');

  // Load mapping (JSON)
  async function loadMapping() {
    try {
      const res = await fetch('/api/mapping');
      if (!res.ok) throw new Error('mapping fetch failed');
      const map = await res.json();
      window.MAP = map;

      // populate IEGs and PLO master list
      iegSel.innerHTML = '<option value="">— Select IEG —</option>';
      (map.IEGs || []).forEach(i => iegSel.append(new Option(i, i)));

      ploSel.innerHTML = '<option value="">— Select PLO —</option>';
      (map.PLOs || []).forEach(p => ploSel.append(new Option(p, p)));

      // optionally populate PEO master (not necessary)
      peoSel.innerHTML = '<option value="">— Select PEO —</option>';
      (map.PEOs || []).forEach(p => peoSel.append(new Option(p, p)));
    } catch (e) {
      console.warn('loadMapping failed', e);
    }
  }

  // IEG -> PEO
  iegSel.addEventListener('change', async () => {
    const ieg = iegSel.value;
    peoSel.innerHTML = '<option value="">Loading…</option>';
    ploSel.innerHTML = '<option value="">— Select PLO —</option>';

    if (!ieg) {
      peoSel.innerHTML = '<option value="">— Select PEO —</option>';
      return;
    }

    try {
      const res = await fetch(`/api/get_peos/${encodeURIComponent(ieg)}`);
      const list = await (res.ok ? res.json() : []);
      peoSel.innerHTML = '<option value="">— Select PEO —</option>';
      (list || []).forEach(p => peoSel.append(new Option(p, p)));

      // set simple IEG label if desired
    } catch (e) {
      peoSel.innerHTML = '<option value="">— Error —</option>';
    }

    // clear statements
    peoStatementEl.textContent = '—';
    ploStatementEl.textContent = '—';
    ploIndicatorEl.textContent = '—';
  });

  // PEO -> PLO
  peoSel.addEventListener('change', async () => {
    const peo = peoSel.value;
    ploSel.innerHTML = '<option value="">Loading…</option>';
    if (!peo) {
      ploSel.innerHTML = '<option value="">— Select PLO —</option>';
      return;
    }
    try {
      const res = await fetch(`/api/get_plos/${encodeURIComponent(peo)}`);
      const list = await (res.ok ? res.json() : []);
      ploSel.innerHTML = '<option value="">— Select PLO —</option>';
      (list || []).forEach(p => ploSel.append(new Option(p, p)));
    } catch (e) {
      ploSel.innerHTML = '<option value="">— Error —</option>';
    }

    // load PEO statement for current level (if available in JSON)
    try {
      const level = levelSel.value || 'Degree';
      const r = await fetch(`/api/get_statement/${encodeURIComponent(level)}/PEO/${encodeURIComponent(peo)}`);
      const text = r.ok ? await r.json() : '';
      peoStatementEl.textContent = text || (window.MAP?.PEOstatements?.[level]?.[peo] || '—');
    } catch (e) { peoStatementEl.textContent = '—'; }

    ploStatementEl.textContent = '—';
    ploIndicatorEl.textContent = '—';
  });

  // PLO selected -> load blooms + auto detect PEO/IEG if possible + statements + indicator
  ploSel.addEventListener('change', async () => {
    const plo = ploSel.value;
    bloomSel.innerHTML = '<option>Loading…</option>';
    verbSel.innerHTML = '<option value="">— Select Verb —</option>';

    if (!plo) {
      bloomSel.innerHTML = '<option value="">— Select Bloom —</option>';
      return;
    }

    // Load blooms
    try {
      const res = await fetch(`/api/get_blooms/${encodeURIComponent(plo)}?profile=${encodeURIComponent(profileSel.value)}`);
      const list = await (res.ok ? res.json() : []);
      bloomSel.innerHTML = '<option value="">— Select Bloom —</option>';
      (list || []).forEach(b => bloomSel.append(new Option(b, b)));
    } catch (e) { bloomSel.innerHTML = '<option value="">— Error —</option>'; }

    // try auto-select PEO + IEG from JSON MAP if available
    try {
      const map = window.MAP || {};
      if (map.PEOtoPLO) {
        for (const [p, arr] of Object.entries(map.PEOtoPLO)) {
          if (Array.isArray(arr) && arr.includes(plo)) {
            peoSel.value = p;
            // fill PEO statement
            try {
              const level = levelSel.value || 'Degree';
              const r = await fetch(`/api/get_statement/${encodeURIComponent(level)}/PEO/${encodeURIComponent(p)}`);
              const text = r.ok ? await r.json() : '';
              peoStatementEl.textContent = text || (map.PEOstatements?.[level]?.[p] || '—');
            } catch (e) { peoStatementEl.textContent = map.PEOstatements?.[level]?.[p] || '—'; }
            break;
          }
        }
      }
      if (map.IEGtoPEO && peoSel.value) {
        for (const [i, peos] of Object.entries(map.IEGtoPEO)) {
          if (Array.isArray(peos) && peos.includes(peoSel.value)) {
            iegSel.value = i;
            break;
          }
        }
      }
    } catch (e) {}

    // PLO Statement + Indicator from JSON
    try {
      const level = levelSel.value || 'Degree';
      const r1 = await fetch(`/api/get_statement/${encodeURIComponent(level)}/PLO/${encodeURIComponent(plo)}`);
      const text1 = r1.ok ? await r1.json() : '';
      ploStatementEl.textContent = text1 || (window.MAP?.PLOstatements?.[level]?.[plo] || '—');
    } catch (e) { ploStatementEl.textContent = window.MAP?.PLOstatements?.[level]?.[plo] || '—'; }

    ploIndicatorEl.textContent = window.MAP?.PLOIndicators?.[plo] || '—';
  });

  // Bloom -> verbs + meta (sc, vbe, condition, criterion)
  bloomSel.addEventListener('change', async () => {
    const bloom = bloomSel.value;
    const plo = ploSel.value;
    verbSel.innerHTML = '<option>Loading…</option>';

    if (!bloom || !plo) {
      verbSel.innerHTML = '<option value="">— Select Verb —</option>';
      return;
    }

    try {
      const r = await fetch(`/api/get_verbs/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}?profile=${encodeURIComponent(profileSel.value)}`);
      const verbs = r.ok ? await r.json() : [];
      verbSel.innerHTML = '<option value="">— Select Verb —</option>';
      (verbs || []).forEach(v => verbSel.append(new Option(v, v)));
    } catch (e) { verbSel.innerHTML = '<option value="">— Error —</option>'; }

    // load meta
    try {
      const mres = await fetch(`/api/get_meta/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}?profile=${encodeURIComponent(profileSel.value)}`);
      const m = mres.ok ? await mres.json() : {};
      scCodeEl.textContent = m.sc_code || '';
      scDescEl.textContent = m.sc_desc || '';
      vbeEl.textContent = m.vbe || '';
      domainEl.textContent = m.domain || '';
      conditionEl.value = m.condition || '';
      criterionEl.value = m.criterion || '';
    } catch (e) {}
  });

  // Generate CLO
  generateBtn.addEventListener('click', async () => {
    if (!ploSel.value || !bloomSel.value || !verbSel.value || !contentEl.value.trim()) {
      alert('Please select PLO, Bloom, Verb and fill Content.');
      return;
    }

    busyEl.style.display = 'inline-block';
    generateBtn.disabled = true;

    try {
      const fd = new FormData();
      fd.append('profile', profileSel.value || 'sc');
      fd.append('plo', ploSel.value);
      fd.append('bloom', bloomSel.value);
      fd.append('verb', verbSel.value);
      fd.append('content', contentEl.value.trim());
      fd.append('course', '');
      fd.append('cw', '');
      fd.append('vbe_style', 'guided');
      fd.append('level', levelSel.value || 'Degree');

      const res = await fetch('/generate', { method: 'POST', body: fd });
      if (!res.ok) {
        const err = await res.json().catch(()=>({error:'Server error'}));
        throw new Error(err.error || 'Failed to generate');
      }
      const data = await res.json();

      // show preview
      previewPanel.style.display = 'block';
      cloPreviewText.innerText = data.clo || '';

      // variants
      variantsPanel.innerHTML = '';
      const clo_options = data.clo_options || {};
      for (const [label, text] of Object.entries(clo_options)) {
        const div = document.createElement('div');
        div.className = 'variant-item';
        div.innerHTML = `<strong>${label}</strong><div class="mt-1">${text}</div>`;
        div.onclick = () => cloPreviewText.innerText = text;
        variantsPanel.appendChild(div);
      }

      // rubric
      if (data.rubric) {
        rubricPanel.style.display = 'block';
        r_indicator.innerText = data.rubric.indicator || '';
        r_excellent.innerText = data.rubric.excellent || '';
        r_good.innerText = data.rubric.good || '';
        r_satisfactory.innerText = data.rubric.satisfactory || '';
        r_poor.innerText = data.rubric.poor || '';
      }

      // fill ui mappings & statements returned by backend (if any)
      if (data.sc_code) scCodeEl.textContent = data.sc_code;
      if (data.sc_desc) scDescEl.textContent = data.sc_desc;
      if (data.vbe) vbeEl.textContent = data.vbe;
      if (data.ieg) iegSel.value = data.ieg;
      if (data.peo) peoSel.value = data.peo;
      if (data.plo_statement) ploStatementEl.textContent = data.plo_statement;
      if (data.peo_statement) peoStatementEl.textContent = data.peo_statement;
      if (data.plo_indicator) ploIndicatorEl.textContent = data.plo_indicator;

      // success
    } catch (err) {
      console.error(err);
      alert('Error: ' + (err.message || 'Failed to generate CLO'));
    } finally {
      busyEl.style.display = 'none';
      generateBtn.disabled = false;
    }
  });


  // toggle variants
  toggleVariantsBtn.addEventListener('click', () => {
    const hidden = variantsPanel.style.display === 'none' || variantsPanel.style.display === '';
    variantsPanel.style.display = hidden ? 'block' : 'none';
    toggleVariantsBtn.innerText = hidden ? 'Hide variants' : 'Show variants';
  });

  // copy preview
  copyCloBtn.addEventListener('click', async () => {
    const text = cloPreviewText.innerText;
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      copyCloBtn.innerText = 'Copied';
      setTimeout(()=> copyCloBtn.innerText = 'Copy', 1500);
    } catch(e){
      alert('Copy failed');
    }
  });

  // init
  (function init() {
    loadMapping();
  })();

  </script>
</body>
</html>
