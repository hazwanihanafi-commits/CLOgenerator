<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SCLOG CLO Generator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f8f9fa; }
        .card-header { font-weight: 600; }
        #clo_output { font-size: 1.05rem; font-weight: 600; padding: 12px; }
    </style>
</head>

<body class="container py-4">

    <h3 class="mb-4">SCLOG Course Learning Outcome Generator</h3>

    <!-- Profile (hidden but required by JS and Flask) -->
    <input type="hidden" id="profile" value="{{ profile }}">

    <!-- ================================
         CLO Generator Form
    ================================= -->
    <div class="card mb-4">
        <div class="card-header">Generate CLO</div>
        <div class="card-body">
            <form id="cloForm">

                <!-- Course -->
                <div class="mb-3">
                    <label class="form-label">Course Code / Name</label>
                    <input type="text" class="form-control" name="course" id="course" placeholder="E.g., SES 301 / Exercise Metabolism">
                </div>

                <!-- PLO Selection -->
                <div class="mb-3">
                    <label class="form-label">Programme Learning Outcome (PLO)</label>
                    <select class="form-select" id="plo" name="plo" required>
                        <option value="">-- Select PLO --</option>
                        {% for p in plos %}
                        <option value="{{ p }}">{{ p }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Bloom Level -->
                <div class="mb-3">
                    <label class="form-label">Bloom Level</label>
                    <select class="form-select" id="bloom" name="bloom">
                        <option value="">-- Select Bloom Level --</option>
                    </select>
                </div>

                <!-- Verb -->
                <div class="mb-3">
                    <label class="form-label">Verb</label>
                    <select class="form-select" id="verb" name="verb">
                        <option value="">-- Select Verb --</option>
                    </select>
                </div>

                <!-- Content (User Input) -->
                <div class="mb-3">
                    <label class="form-label">Content / Substance</label>
                    <input type="text" class="form-control" name="content" id="content" placeholder="e.g., leadership styles, exercise metabolism, etc." required>
                </div>

                <!-- Coursework Weightage -->
                <div class="mb-3">
                    <label class="form-label">Coursework Weight (%)</label>
                    <input type="number" class="form-control" name="cw" id="cw" min="0" max="100" required>
                </div>

            </form>
        </div>
    </div>


    <!-- ================================
         CLO OUTPUT PREVIEW
    ================================= -->
    <div class="card mb-4">
        <div class="card-header">Generated CLO Preview</div>
        <div class="card-body">
            <div id="clo_output" class="border rounded bg-white p-3">CLO will appear here...</div>
        </div>
    </div>


    <!-- ================================
         Assessment & Evidence
    ================================= -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">Assessment Methods</div>
                <div class="card-body">
                    <textarea id="assessment" name="assessment" class="form-control" rows="5"></textarea>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">Evidence of Assessment</div>
                <div class="card-body">
                    <textarea id="evidence" name="evidence" class="form-control" rows="5"></textarea>
                </div>
            </div>
        </div>
    </div>


    <!-- ================================
         Table of Existing CLOs
    ================================= -->
    <div class="card">
        <div class="card-header">CLO Table Records</div>
        <div class="card-body">
            {{ table_html|safe }}
        </div>
    </div>


    <!-- Bootstrap & JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


    <!-- ================================
         AJAX Logic
    ================================= -->
    <script>
        const profile = document.getElementById("profile").value;

        // ==========================================
        // Load Bloom options when PLO changes
        // ==========================================
        document.getElementById("plo").addEventListener("change", function () {
            const plo = this.value.trim();
            if (!plo) return;

            fetch(`/api/get_blooms/${plo}?profile=` + profile)
                .then(res => res.json())
                .then(data => {
                    const bloomSel = document.getElementById("bloom");
                    bloomSel.innerHTML = `<option value="">-- Select Bloom Level --</option>`;
                    data.forEach(b => {
                        bloomSel.innerHTML += `<option value="${b}">${b}</option>`;
                    });
                });
        });


        // ==========================================
        // Load Verbs when Bloom changes
        // ==========================================
        document.getElementById("bloom").addEventListener("change", function () {
            const plo = document.getElementById("plo").value.trim();
            const bloom = this.value.trim();
            if (!plo || !bloom) return;

            fetch(`/api/get_verbs/${plo}/${bloom}?profile=` + profile)
                .then(res => res.json())
                .then(data => {
                    const verbSel = document.getElementById("verb");
                    verbSel.innerHTML = `<option value="">-- Select Verb --</option>`;
                    data.forEach(v => {
                        verbSel.innerHTML += `<option value="${v}">${v}</option>`;
                    });
                });

            autoGeneratePreview();
        });


        // ==========================================
        // Auto-generate CLO + Assessment + Evidence
        // ==========================================
        function autoGeneratePreview() {
            const form = document.getElementById("cloForm");
            const formData = new FormData(form);

            fetch(`/generate?profile=${profile}&preview=1`, {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.clo) document.getElementById("clo_output").innerText = data.clo;
                if (data.assessment) document.getElementById("assessment").value = data.assessment;
                if (data.evidence) document.getElementById("evidence").value = data.evidence;
            })
            .catch(err => console.log("Preview Error:", err));
        }

        // Trigger preview when verb/content changes
        document.getElementById("verb").addEventListener("change", autoGeneratePreview);
        document.getElementById("content").addEventListener("input", autoGeneratePreview);
    </script>

</body>
</html>
