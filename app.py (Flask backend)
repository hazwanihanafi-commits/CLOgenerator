from flask import Flask, render_template, request, jsonify, send_file, redirect, url_for
import pandas as pd
import os
from datetime import datetime
from openpyxl import load_workbook
from io import BytesIO

app = Flask(__name__, template_folder="templates")

WORKBOOK_PATH = os.path.join(os.getcwd(), "SCLOG.xlsx")

# =====================================================================
#                         DISCIPLINE → SHEET MAP
# =====================================================================
PROFILE_SHEET_MAP = {
    "": "Mapping",              # Default
    "health": "Mapping_health",
    "sc": "Mapping_sc",
    "eng": "Mapping_eng",
    "socs": "Mapping_socs",
    "edu": "Mapping_edu",
    "bus": "Mapping_bus",
    "arts": "Mapping_arts"
}

# =====================================================================
#                           BASIC UTILITIES
# =====================================================================

def load_sheet_df(sheet_name):
    try:
        return pd.read_excel(WORKBOOK_PATH, sheet_name=sheet_name, engine="openpyxl")
    except Exception:
        return pd.DataFrame()


def get_mapping_dict(profile=None):
    profile = (profile or "").strip().lower()
    sheet = PROFILE_SHEET_MAP.get(profile, "Mapping")

    df = load_sheet_df(sheet)
    if df.empty:
        return pd.DataFrame()

    df.columns = [c.strip() for c in df.columns]
    return df


def get_plo_details(plo, profile=None):
    df = get_mapping_dict(profile)
    if df.empty:
        return None

    mask = df[df.columns[0]].astype(str).str.strip().str.upper() == plo.upper()
    if not mask.any():
        return None

    row = df[mask].iloc[0]
    cols = {c.lower(): c for c in df.columns}

    return {
        "plo": plo,
        "sc_code": row.get(cols.get("sc code"), ""),
        "sc_desc": row.get(cols.get("sc description"), ""),
        "vbe": row.get(cols.get("vbe"), ""),
        "domain": row.get(cols.get("domain"), "")
    }

# =====================================================================
#                      CRITERION / CONDITION / ASSESSMENT
# =====================================================================

def get_criterion_condition(domain, bloom):
    df = load_sheet_df("Criterion")
    if df.empty:
        return "", ""

    df.columns = [c.strip() for c in df.columns]

    mask = (
        df[df.columns[0]].astype(str).str.lower() == domain.lower()
    ) & (
        df[df.columns[1]].astype(str).str.lower() == bloom.lower()
    )

    if not mask.any():
        return "", ""

    row = df[mask].iloc[0]
    return str(row[df.columns[2]]), str(row[df.columns[3]])


def get_default_condition(domain):
    fallback = {
        "cognitive": "when interpreting data or solving problems",
        "affective": "during clinical, group, or reflective activities",
        "psychomotor": "under supervised practical conditions"
    }
    return fallback.get(domain.lower(), "")


def get_assessment_and_evidence(bloom, domain):
    domain = domain.lower()

    if domain in ("affective", "psychomotor"):
        df = load_sheet_df("Assess_Affective_Psychomotor")
    else:
        df = load_sheet_df("Bloom_Assessments")

    if df.empty:
        return "", ""

    df.columns = [c.strip() for c in df.columns]

    mask = df[df.columns[0]].astype(str).str.lower() == bloom.lower()
    if not mask.any():
        return "", ""

    row = df[mask].iloc[0]
    return str(row[df.columns[1]]), str(row[df.columns[2]])

# =====================================================================
#                         CLO SENTENCE BUILDER
# =====================================================================

def construct_clo_sentence(verb, content, sc_desc, condition, criterion, vbe):
    """
    MQF-compliant CLO construction:
    Verb + Content + using SC Description + [condition] + [criterion] + guided by VBE
    """

    parts = []

    # Verb + Content
    base = f"{verb.strip().lower()} {content.strip()}"
    parts.append(base)

    # SC Description
    if sc_desc:
        parts.append(f"using {sc_desc.lower()}")

    # Condition
    if condition:
        cond = condition.strip()
        if not cond.lower().startswith(("when", "during", "under", "based")):
            cond = "when " + cond
        parts.append(cond)

    # Criterion (effectively, accurately, professionally)
    if criterion:
        parts.append(criterion.strip())

    # Value-Based Education element
    if vbe:
        parts.append(f"guided by {vbe.lower()}")

    # Merge into a readable CLO
    text = " ".join(parts).replace("  ", " ").strip()
    text = text[0].upper() + text[1:]
    if not text.endswith("."):
        text += "."

    return text

# =====================================================================
#                         TABLE HANDLING
# =====================================================================

def read_clo_table():
    try:
        return pd.read_excel(WORKBOOK_PATH, sheet_name="CLO_Table", engine="openpyxl")
    except:
        return pd.DataFrame()


def write_clo_table(df):
    book = load_workbook(WORKBOOK_PATH)
    if "CLO_Table" in book.sheetnames:
        del book["CLO_Table"]
    with pd.ExcelWriter(WORKBOOK_PATH, engine="openpyxl", mode="a") as writer:
        writer._book = book
        df.to_excel(writer, sheet_name="CLO_Table", index=False)

# =====================================================================
#                                ROUTES
# =====================================================================

@app.route("/")
def index():
    profile = request.args.get("profile", "").strip().lower()
    df = get_mapping_dict(profile)

    plos = df[df.columns[0]].dropna().astype(str).tolist() if not df.empty else []

    df_ct = read_clo_table()
    table_html = df_ct.to_html(classes="table table-striped table-sm", index=False) if not df_ct.empty else "<p>No CLO generated yet.</p>"

    return render_template("generator.html", plos=plos, table_html=table_html, profile=profile)

# ---------------------------------------------------------------------

@app.route("/generate", methods=["POST"])
def generate():
    plo = request.form.get("plo")
    bloom = request.form.get("bloom")
    verb = request.form.get("verb")
    content = request.form.get("content")
    course = request.form.get("course")
    cw = request.form.get("cw")

    profile = request.args.get("profile", "").strip().lower()

    details = get_plo_details(plo, profile)
    if not details:
        return jsonify({"error": "PLO not found"}), 400

    domain = details["domain"]

    # Condition & Criterion
    criterion, condition = get_criterion_condition(domain, bloom)
    if not condition:
        condition = get_default_condition(domain)

    # Assessment & Evidence
    assessment, evidence = get_assessment_and_evidence(bloom, domain)

    # Construct CLO
    clo = construct_clo_sentence(
        verb, content, details["sc_desc"], condition, criterion, details["vbe"]
    )

    # Save to log
    df = read_clo_table()
    new_row = {
        "ID": len(df) + 1 if not df.empty else 1,
        "Time": datetime.now().strftime("%Y-%m-%d %H:%M"),
        "Course": course,
        "PLO": plo,
        "Bloom": bloom,
        "FullCLO": clo,
        "Mapping (SC + VBE)": f"{details['sc_code']} — {details['vbe']}",
        "Assessment Methods": assessment,
        "Evidence of Assessment": evidence,
        "Coursework Assessment Percentage (%)": cw,
        "Profile": profile
    }

    df = pd.concat([df, pd.DataFrame([new_row])], ignore_index=True)
    write_clo_table(df)

    return jsonify({
        "clo": clo,
        "assessment": assessment,
        "evidence": evidence
    })

# ---------------------------------------------------------------------

@app.route("/api/get_blooms/<plo>")
def api_get_blooms(plo):
    profile = request.args.get("profile", "").strip().lower()
    details = get_plo_details(plo, profile)

    if not details:
        return jsonify([])

    domain = details["domain"].lower()
    sheet_map = {
        "cognitive": "Bloom_Cognitive",
        "affective": "Bloom_Affective",
        "psychomotor": "Bloom_Psychomotor"
    }

    df = load_sheet_df(sheet_map.get(domain))
    if df.empty:
        return jsonify([])

    blooms = df.iloc[:, 0].dropna().astype(str).tolist()
    return jsonify(blooms)

# ---------------------------------------------------------------------

@app.route("/api/get_verbs/<plo>/<bloom>")
def api_get_verbs(plo, bloom):
    profile = request.args.get("profile", "").strip().lower()
    details = get_plo_details(plo, profile)

    if not details:
        return jsonify([])

    domain = details["domain"].lower()

    sheet_map = {
        "cognitive": "Bloom_Cognitive",
        "affective": "Bloom_Affective",
        "psychomotor": "Bloom_Psychomotor"
    }

    df = load_sheet_df(sheet_map.get(domain))
    if df.empty:
        return jsonify([])

    mask = df.iloc[:, 0].astype(str).str.lower() == bloom.lower()
    if not mask.any():
        return jsonify([])

    verbs = [v.strip() for v in str(df.loc[mask].iloc[0, 1]).split(",")]
    return jsonify(verbs)

# ---------------------------------------------------------------------

@app.route("/api/get_meta/<plo>/<bloom>")
def api_get_meta(plo, bloom):
    profile = request.args.get("profile", "").strip().lower()
    details = get_plo_details(plo, profile)

    if not details:
        return jsonify({})

    domain = details["domain"]

    criterion, condition = get_criterion_condition(domain, bloom)
    if not condition:
        condition = get_default_condition(domain)

    assessment, evidence = get_assessment_and_evidence(bloom, domain)

    return jsonify({
        "sc_code": details["sc_code"],
        "sc_desc": details["sc_desc"],
        "vbe": details["vbe"],
        "domain": details["domain"],
        "condition": condition,
        "criterion": criterion,
        "assessment": assessment,
        "evidence": evidence
    })

# ---------------------------------------------------------------------

@app.route("/reset_table")
def reset_table():
    df = pd.DataFrame(columns=[
        "ID","Time","Course","PLO","Bloom","FullCLO",
        "Mapping (SC + VBE)","Assessment Methods","Evidence of Assessment",
        "Coursework Assessment Percentage (%)","Profile"
    ])

    book = load_workbook(WORKBOOK_PATH)
    if "CLO_Table" in book.sheetnames:
        del book["CLO_Table"]

    with pd.ExcelWriter(WORKBOOK_PATH, engine="openpyxl", mode="a") as writer:
        writer._book = book
        df.to_excel(writer, sheet_name="CLO_Table", index=False)

    return redirect(url_for("index"))

# ---------------------------------------------------------------------

@app.route("/download")
def download():
    df = read_clo_table()
    if df.empty:
        return "<p>No CLO table to download.</p>"

    output = BytesIO()
    with pd.ExcelWriter(output, engine="openpyxl") as writer:
        df.to_excel(writer, sheet_name="CLO_Table", index=False)

    output.seek(0)
    return send_file(
        output,
        as_attachment=True,
        download_name="CLO_Table.xlsx",
        mimetype="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    )

# =====================================================================
if __name__ == "__main__":
    app.run(debug=True)
